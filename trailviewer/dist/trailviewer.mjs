import e from"cheap-ruler";import t from"mapbox-gl";import{EventEmitter as a}from"events";import i from"url-join";window.libpannellum=function(e,t,a){function i(i,c){function d(e,t){return 1==e.level&&1!=t.level?-1:1==t.level&&1!=e.level?1:t.timestamp-e.timestamp}function u(e,t){return e.level!=t.level?e.level-t.level:e.diff-t.diff}function f(e,t,a,i,n,o,r){this.vertices=e,this.side=t,this.level=a,this.x=i,this.y=n,e=(e="object"==typeof o?o.tileKey:o).replace("%s",t).replace("%l0",a-1).replace("%l",a).replace("%x",i).replace("%y",n),this.path="object"==typeof o?o[e]:e,this.parentPath=r}function m(e,t,a,i,n,o){var r;r=b(e,(l=a.vertices).slice(0,3));var s=b(e,l.slice(3,6)),h=b(e,l.slice(6,9)),l=b(e,l.slice(9,12));if(-4==(c=r[0]+s[0]+h[0]+l[0])||4==c?r=!1:r=-4!=(c=r[1]+s[1]+h[1]+l[1])&&4!=c&&4!=r[2]+s[2]+h[2]+l[2],r){var c=[],d=[],u=2,p=[],g=0;for(l=0;4>l;l++)r=y(t,a.vertices.slice(3*l,3*(l+1))),c.push(r[0]*r[3]),d.push(r[1]*r[3]),r=r[2]*r[3],u=Math.min(u,r),p.push(1>=Math.abs(c[l])&&1>=Math.abs(d[l])&&0<r),g+=p[l];if(h=O.cubeResolution*Math.pow(2,a.level-O.maxLevel),r=Math.ceil(h*O.invTileResolution)-1,s=h%O.tileResolution*2,0===(h=2*h%O.tileResolution)&&(h=O.tileResolution),0===s&&(s=2*O.tileResolution),1<a.level&&0<u&&0<g){for(l=u=0;4>l;l++)if(g=(l+1)%4,p[l]||p[g]){var v=(c[g]-c[l])*R.drawingBufferWidth/2;g=(d[g]-d[l])*R.drawingBufferHeight/2;h<O.tileResolution&&(a.x==r?v*=O.tileResolution/h:a.y==r&&(g*=O.tileResolution/h)),s<=O.tileResolution&&(a.x==r&&(v*=2),a.y==r&&(g*=2)),u=Math.max(u,Math.sqrt(v*v+g*g))}if(u<=O.tileResolution/2)return}for(l=(c=a.vertices)[0]+c[3]+c[6]+c[9],d=c[1]+c[4]+c[7]+c[10],p=c[2]+c[5]+c[8]+c[11],u=Math.sqrt(l*l+d*d+p*p),p=Math.asin(p/u),l=Math.atan2(d,l)-n,l+=l>Math.PI?-2*Math.PI:l<-Math.PI?2*Math.PI:0,l=Math.abs(l),a.diff=Math.acos(Math.sin(i)*Math.sin(p)+Math.cos(i)*Math.cos(p)*Math.cos(l)),l=!1,d=0;d<T.nodeCache.length;d++)if(T.nodeCache[d].path==a.path){l=!0,T.nodeCache[d].timestamp=T.nodeCacheTimestamp++,T.nodeCache[d].diff=a.diff,T.currentNodes.push(T.nodeCache[d]);break}if(l||(a.timestamp=T.nodeCacheTimestamp++,T.currentNodes.push(a),T.nodeCache.push(a)),a.level<O.maxLevel){p=.5,a.x!=r&&a.y!=r||(p=1-O.tileResolution/(O.tileResolution+h));d=[],v=g=u=p;var w=l=1-p,_=l,x=l;for(h<O.tileResolution&&(a.x==r&&a.y!=r?(_=g=.5,("d"==a.side||"u"==a.side)&&(x=v=.5)):a.x!=r&&a.y==r&&(w=u=.5,"l"==a.side||"r"==a.side)&&(x=v=.5)),s<=O.tileResolution&&(a.x==r&&(u=0,w=1,"l"==a.side||"r"==a.side)&&(v=0,x=1),a.y==r&&(g=0,_=1,"d"==a.side||"u"==a.side)&&(v=0,x=1)),h=new f(h=new Float32Array([c[0],c[1],c[2],c[0]*u+c[3]*w,c[1]*p+c[4]*l,c[2]*v+c[5]*x,c[0]*u+c[6]*w,c[1]*g+c[7]*_,c[2]*v+c[8]*x,c[0]*p+c[9]*l,c[1]*g+c[10]*_,c[2]*v+c[11]*x]),a.side,a.level+1,2*a.x,2*a.y,O.fullpath,a.path),d.push(h),a.x==r&&s<=O.tileResolution||(h=new f(h=new Float32Array([c[0]*u+c[3]*w,c[1]*p+c[4]*l,c[2]*v+c[5]*x,c[3],c[4],c[5],c[3]*p+c[6]*l,c[4]*g+c[7]*_,c[5]*v+c[8]*x,c[0]*u+c[6]*w,c[1]*g+c[7]*_,c[2]*v+c[8]*x]),a.side,a.level+1,2*a.x+1,2*a.y,O.fullpath,a.path),d.push(h)),a.x==r&&s<=O.tileResolution||a.y==r&&s<=O.tileResolution||(h=new f(h=new Float32Array([c[0]*u+c[6]*w,c[1]*g+c[7]*_,c[2]*v+c[8]*x,c[3]*p+c[6]*l,c[4]*g+c[7]*_,c[5]*v+c[8]*x,c[6],c[7],c[8],c[9]*u+c[6]*w,c[10]*p+c[7]*l,c[11]*v+c[8]*x]),a.side,a.level+1,2*a.x+1,2*a.y+1,O.fullpath,a.path),d.push(h)),a.y==r&&s<=O.tileResolution||(h=new f(h=new Float32Array([c[0]*p+c[9]*l,c[1]*g+c[10]*_,c[2]*v+c[11]*x,c[0]*u+c[6]*w,c[1]*g+c[7]*_,c[2]*v+c[8]*x,c[9]*u+c[6]*w,c[10]*p+c[7]*l,c[11]*v+c[8]*x,c[9],c[10],c[11]]),a.side,a.level+1,2*a.x,2*a.y+1,O.fullpath,a.path),d.push(h)),g=0;g<d.length;g++)m(e,t,d[g],i,n)}}}function p(){return new Float32Array([-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1])}function g(e,t,a){var i=Math.sin(t);return t=Math.cos(t),"x"==a?new Float32Array([e[0],t*e[1]+i*e[2],t*e[2]-i*e[1],e[3],t*e[4]+i*e[5],t*e[5]-i*e[4],e[6],t*e[7]+i*e[8],t*e[8]-i*e[7]]):"y"==a?new Float32Array([t*e[0]-i*e[2],e[1],t*e[2]+i*e[0],t*e[3]-i*e[5],e[4],t*e[5]+i*e[3],t*e[6]-i*e[8],e[7],t*e[8]+i*e[6]]):"z"==a?new Float32Array([t*e[0]+i*e[1],t*e[1]-i*e[0],e[2],t*e[3]+i*e[4],t*e[4]-i*e[3],e[5],t*e[6]+i*e[7],t*e[7]-i*e[6],e[8]]):void 0}function v(e){return new Float32Array([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]])}function w(e,t,a,i){return e=2*Math.atan(Math.tan(e/2)*R.drawingBufferHeight/R.drawingBufferWidth),e=1/Math.tan(e/2),new Float32Array([e/t,0,0,0,0,e,0,0,0,0,(i+a)/(a-i),2*i*a/(a-i),0,0,-1,0])}function _(e,t){return new Float32Array([e[0]*t[0],e[0]*t[1],e[0]*t[2],0,e[5]*t[4],e[5]*t[5],e[5]*t[6],0,e[10]*t[8],e[10]*t[9],e[10]*t[10],e[11],-t[8],-t[9],-t[10],0])}function y(e,t){return new Float32Array([e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[4]*t[0]+e[5]*t[1]+e[6]*t[2],e[11]+e[8]*t[0]+e[9]*t[1]+e[10]*t[2],1/(e[12]*t[0]+e[13]*t[1]+e[14]*t[2])])}function b(e,t){var a=(n=y(e,t))[0]*n[3],i=n[1]*n[3],n=n[2]*n[3],o=[0,0,0];return-1>a&&(o[0]=-1),1<a&&(o[0]=1),-1>i&&(o[1]=-1),1<i&&(o[1]=1),(-1>n||1<n)&&(o[2]=1),o}function x(){console.log("Reducing canvas size due to error 1286!"),I.width=Math.round(I.width/2),I.height=Math.round(I.height/2)}function E(e,t){return Math.pow((Math.abs(e)-t)/t,2)*(0<e-t?1:-1)}function M(e,t){for(var a=Math.floor(e.length/t),i=[],n=0;n<a;n++){for(var o=0,r=0;r<t;r++)o=83*o+K.indexOf(e[n*t+r]);i.push(o)}return i}function P(e,t,a){var i=Math.floor(Math.sqrt(e.length))-1,n=Array(i+1),o=Array(i+1);o[0]=0,n[0]=1,o[1]=Math.sin(a),n[1]=Math.cos(a);for(var r=2;r<=i;r++)o[r]=2*o[r-1]*n[1]-o[r-2],n[r]=2*n[r-1]*n[1]-n[r-2];var s=a=0;for(r=1;r<=i+1;r++)s+=r;for(;0<=i;i--){var h=Math.floor((i+1)*i/2);for(a+=0!=h?e[h]*t[h-1]:e[h],r=1;r<=i;r++)a+=(e[++h]*n[r]+e[h+s-i-1]*o[r])*t[h-1]}return Math.round(a)}var I;i&&((I=t.createElement("canvas")).style.width=I.style.height="100%",i.appendChild(I));var T,R,A,L,C,S,D,N,F,k,B,O,U,H,z,G,Y,q,V,X="fbudlr".split(""),W="frblud".split("");c&&(R=c),this.init=function(e,c,d,u,f,m,g,v){function w(e){if(b){var t=e*e*4,a=new Uint8ClampedArray(t),i=v.backgroundColor?v.backgroundColor:[0,0,0];i[0]*=255,i[1]*=255,i[2]*=255;for(var n=0;n<t;n++)a[n++]=i[0],a[n++]=i[1],a[n++]=i[2];for(e=new ImageData(a,e,e),_=0;6>_;_++)0==O[_].width&&(O[_]=e)}}if(c===a&&(c="equirectangular"),"equirectangular"!=c&&"cubemap"!=c&&"multires"!=c)throw console.log("Error: invalid image type specified!"),{type:"config error"};if(U=c,O=e,H=d,V=v||{},T){if(A&&(R.detachShader(T,A),R.deleteShader(A)),L&&(R.detachShader(T,L),R.deleteShader(L)),R.bindBuffer(R.ARRAY_BUFFER,null),R.bindBuffer(R.ELEMENT_ARRAY_BUFFER,null),T.texture&&R.deleteTexture(T.texture),T.nodeCache)for(e=0;e<T.nodeCache.length;e++)R.deleteTexture(T.nodeCache[e].texture);if(T.textureLoads)for(Z=[];0<T.textureLoads.length;)T.textureLoads.shift()(!1);R.deleteProgram(T),T=a}C&&(S&&(R.detachShader(C,S),R.deleteShader(S)),D&&(R.detachShader(C,D),R.deleteShader(D)),R.deleteProgram(C),C=a),B=a;var _,y,b=!1;if("cubemap"==U)for(_=0;6>_;_++)0<O[_].width?(y===a&&(y=O[_].width),y!=O[_].width&&console.log("Cube faces have inconsistent widths: "+y+" vs. "+O[_].width)):b=!0;if("cubemap"==U&&0!=(y&y-1)&&(navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 8_/)||navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 9_/)||navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 10_/)||navigator.userAgent.match(/Trident.*rv[ :]*11\./))||(R||(R=I.getContext("experimental-webgl",{alpha:!1,depth:!1})),R&&1286==R.getError()&&x()),!R&&("multires"==U&&O.hasOwnProperty("fallbackPath")||"cubemap"==U)&&("WebkitAppearance"in t.documentElement.style||navigator.userAgent.match(/Trident.*rv[ :]*11\./)||-1!==navigator.appVersion.indexOf("MSIE 10"))){F&&i.removeChild(F),(F=t.createElement("div")).className="pnlm-world",u=O.basePath?O.basePath+O.fallbackPath:O.fallbackPath;var X=0;f=function(){var e=t.createElement("canvas");e.className="pnlm-face pnlm-"+W[this.side]+"face",F.appendChild(e);var a=e.getContext("2d");e.style.width=this.width+4+"px",e.style.height=this.height+4+"px",e.width=this.width+4,e.height=this.height+4,a.drawImage(this,2,2);var i,n,o=a.getImageData(0,0,e.width,e.height),r=o.data;for(i=2;i<e.width-2;i++)for(n=0;4>n;n++)r[4*(i+e.width)+n]=r[4*(i+2*e.width)+n],r[4*(i+e.width*(e.height-2))+n]=r[4*(i+e.width*(e.height-3))+n];for(i=2;i<e.height-2;i++)for(n=0;4>n;n++)r[4*(i*e.width+1)+n]=r[4*(i*e.width+2)+n],r[4*((i+1)*e.width-2)+n]=r[4*((i+1)*e.width-3)+n];for(n=0;4>n;n++)r[4*(e.width+1)+n]=r[4*(2*e.width+2)+n],r[4*(2*e.width-2)+n]=r[4*(3*e.width-3)+n],r[4*(e.width*(e.height-2)+1)+n]=r[4*(e.width*(e.height-3)+2)+n],r[4*(e.width*(e.height-1)-2)+n]=r[4*(e.width*(e.height-2)-3)+n];for(i=1;i<e.width-1;i++)for(n=0;4>n;n++)r[4*i+n]=r[4*(i+e.width)+n],r[4*(i+e.width*(e.height-1))+n]=r[4*(i+e.width*(e.height-2))+n];for(i=1;i<e.height-1;i++)for(n=0;4>n;n++)r[i*e.width*4+n]=r[4*(i*e.width+1)+n],r[4*((i+1)*e.width-1)+n]=r[4*((i+1)*e.width-2)+n];for(n=0;4>n;n++)r[n]=r[4*(e.width+1)+n],r[4*(e.width-1)+n]=r[4*(2*e.width-2)+n],r[e.width*(e.height-1)*4+n]=r[4*(e.width*(e.height-2)+1)+n],r[4*(e.width*e.height-1)+n]=r[4*(e.width*(e.height-1)-2)+n];a.putImageData(o,0,0),j.call(this)};var j=function(){0<this.width?(N===a&&(N=this.width),N!=this.width&&console.log("Fallback faces have inconsistent widths: "+N+" vs. "+this.width)):b=!0,6==++X&&(N=this.width,i.appendChild(F),g())};b=!1;for(_=0;6>_;_++)(m=new Image).crossOrigin=V.crossOrigin?V.crossOrigin:"anonymous",m.side=_,m.onload=f,m.onerror=j,m.src="multires"==U?u.replace("%s",W[_])+(O.extension?"."+O.extension:""):O[_].src;w(N)}else{if(!R)throw console.log("Error: no WebGL support detected!"),{type:"no webgl"};for("cubemap"==U&&w(y),O.fullpath=O.basePath?O.basePath+O.path:O.path,O.invTileResolution=1/O.tileResolution,e=p(),k=[],_=0;6>_;_++)k[_]=e.slice(12*_,12*_+12),e=p();if(e=0,"equirectangular"==U){if(e=R.getParameter(R.MAX_TEXTURE_SIZE),Math.max(O.width/2,O.height)>e)throw console.log("Error: The image is too big; it's "+O.width+"px wide, but this device's maximum supported size is "+2*e+"px."),{type:"webgl size error",width:O.width,maxWidth:2*e}}else if("cubemap"==U&&y>R.getParameter(R.MAX_CUBE_MAP_TEXTURE_SIZE))throw console.log("Error: The image is too big; it's "+y+"px wide, but this device's maximum supported size is "+e+"px."),{type:"webgl size error",width:y,maxWidth:e};v!==a&&(y=isNaN(v.horizonPitch)?0:Number(v.horizonPitch),c=isNaN(v.horizonRoll)?0:Number(v.horizonRoll),0!=y||0!=c)&&(B=[y,c]);var $=R.TEXTURE_2D;if(R.viewport(0,0,R.drawingBufferWidth,R.drawingBufferHeight),R.getShaderPrecisionFormat&&(y=R.getShaderPrecisionFormat(R.FRAGMENT_SHADER,R.HIGH_FLOAT))&&1>y.precision&&(r=r.replace("highp","mediump")),A=R.createShader(R.VERTEX_SHADER),y=n,"multires"==U&&(y=o),R.shaderSource(A,y),R.compileShader(A),L=R.createShader(R.FRAGMENT_SHADER),y=h,"cubemap"==U?($=R.TEXTURE_CUBE_MAP,y=s):"multires"==U&&(y=l),R.shaderSource(L,y),R.compileShader(L),T=R.createProgram(),R.attachShader(T,A),R.attachShader(T,L),R.linkProgram(T),R.getShaderParameter(A,R.COMPILE_STATUS)||console.log(R.getShaderInfoLog(A)),R.getShaderParameter(L,R.COMPILE_STATUS)||console.log(R.getShaderInfoLog(L)),R.getProgramParameter(T,R.LINK_STATUS)||console.log(R.getProgramInfoLog(T)),R.useProgram(T),T.drawInProgress=!1,null!==v.backgroundColor){var K=v.backgroundColor?v.backgroundColor:[0,0,0];R.clearColor(K[0],K[1],K[2],1),R.clear(R.COLOR_BUFFER_BIT)}if(T.texCoordLocation=R.getAttribLocation(T,"a_texCoord"),R.enableVertexAttribArray(T.texCoordLocation),"multires"!=U)z||(z=R.createBuffer()),R.bindBuffer(R.ARRAY_BUFFER,z),R.bufferData(R.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),R.STATIC_DRAW),R.vertexAttribPointer(T.texCoordLocation,2,R.FLOAT,!1,0,0),T.aspectRatio=R.getUniformLocation(T,"u_aspectRatio"),R.uniform1f(T.aspectRatio,R.drawingBufferWidth/R.drawingBufferHeight),T.psi=R.getUniformLocation(T,"u_psi"),T.theta=R.getUniformLocation(T,"u_theta"),T.f=R.getUniformLocation(T,"u_f"),T.h=R.getUniformLocation(T,"u_h"),T.v=R.getUniformLocation(T,"u_v"),T.vo=R.getUniformLocation(T,"u_vo"),T.rot=R.getUniformLocation(T,"u_rot"),R.uniform1f(T.h,u/(2*Math.PI)),R.uniform1f(T.v,f/Math.PI),R.uniform1f(T.vo,m/Math.PI*2),"equirectangular"==U&&(T.backgroundColor=R.getUniformLocation(T,"u_backgroundColor"),R.uniform4fv(T.backgroundColor,K.concat([1]))),T.texture=R.createTexture(),R.bindTexture($,T.texture),"cubemap"==U?(R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_X,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O[1]),R.texImage2D(R.TEXTURE_CUBE_MAP_NEGATIVE_X,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O[3]),R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_Y,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O[4]),R.texImage2D(R.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O[5]),R.texImage2D(R.TEXTURE_CUBE_MAP_POSITIVE_Z,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O[0]),R.texImage2D(R.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O[2])):O.width<=e?(R.uniform1i(R.getUniformLocation(T,"u_splitImage"),0),R.texImage2D($,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O)):(R.uniform1i(R.getUniformLocation(T,"u_splitImage"),1),(f=t.createElement("canvas")).width=O.width/2,f.height=O.height,(f=f.getContext("2d")).drawImage(O,0,0),m=f.getImageData(0,0,O.width/2,O.height),R.texImage2D($,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,m),T.texture2=R.createTexture(),R.activeTexture(R.TEXTURE1),R.bindTexture($,T.texture2),R.uniform1i(R.getUniformLocation(T,"u_image1"),1),f.drawImage(O,-O.width/2,0),m=f.getImageData(0,0,O.width/2,O.height),R.texImage2D($,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,m),R.texParameteri($,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri($,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),R.texParameteri($,R.TEXTURE_MIN_FILTER,R.LINEAR),R.texParameteri($,R.TEXTURE_MAG_FILTER,R.LINEAR),R.activeTexture(R.TEXTURE0)),"cubemap"!=U&&O.width<=e&&u==2*Math.PI&&0==(O.width&O.width-1)?R.texParameteri($,R.TEXTURE_WRAP_S,R.REPEAT):R.texParameteri($,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri($,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),R.texParameteri($,R.TEXTURE_MIN_FILTER,R.LINEAR),R.texParameteri($,R.TEXTURE_MAG_FILTER,R.LINEAR);else if(T.vertPosLocation=R.getAttribLocation(T,"a_vertCoord"),R.enableVertexAttribArray(T.vertPosLocation),G||(G=R.createBuffer()),Y||(Y=R.createBuffer()),q||(q=R.createBuffer()),R.bindBuffer(R.ARRAY_BUFFER,Y),R.bufferData(R.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),R.STATIC_DRAW),R.vertexAttribPointer(T.texCoordLocation,2,R.FLOAT,!1,0,0),R.bindBuffer(R.ELEMENT_ARRAY_BUFFER,q),R.bufferData(R.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),R.STATIC_DRAW),R.bindBuffer(R.ARRAY_BUFFER,G),R.vertexAttribPointer(T.vertPosLocation,3,R.FLOAT,!1,0,0),T.perspUniform=R.getUniformLocation(T,"u_perspMatrix"),T.cubeUniform=R.getUniformLocation(T,"u_cubeMatrix"),T.currentNodes=[],T.nodeCache=[],T.nodeCacheTimestamp=0,T.textureLoads=[],O.shtHash||O.equirectangularThumbnail){S=R.createShader(R.VERTEX_SHADER),R.shaderSource(S,n),R.compileShader(S),D=R.createShader(R.FRAGMENT_SHADER),R.shaderSource(D,h),R.compileShader(D),C=R.createProgram(),R.attachShader(C,S),R.attachShader(C,D),R.linkProgram(C),R.getShaderParameter(S,R.COMPILE_STATUS)||console.log(R.getShaderInfoLog(S)),R.getShaderParameter(D,R.COMPILE_STATUS)||console.log(R.getShaderInfoLog(D)),R.getProgramParameter(C,R.LINK_STATUS)||console.log(R.getProgramInfoLog(C)),R.useProgram(C),C.texCoordLocation=R.getAttribLocation(C,"a_texCoord"),R.enableVertexAttribArray(C.texCoordLocation),z||(z=R.createBuffer()),R.bindBuffer(R.ARRAY_BUFFER,z),R.bufferData(R.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),R.STATIC_DRAW),R.vertexAttribPointer(C.texCoordLocation,2,R.FLOAT,!1,0,0),C.aspectRatio=R.getUniformLocation(C,"u_aspectRatio"),R.uniform1f(C.aspectRatio,R.drawingBufferWidth/R.drawingBufferHeight),C.psi=R.getUniformLocation(C,"u_psi"),C.theta=R.getUniformLocation(C,"u_theta"),C.f=R.getUniformLocation(C,"u_f"),C.h=R.getUniformLocation(C,"u_h"),C.v=R.getUniformLocation(C,"u_v"),C.vo=R.getUniformLocation(C,"u_vo"),C.rot=R.getUniformLocation(C,"u_rot"),R.uniform1f(C.h,1),C.texture=R.createTexture(),R.bindTexture($,C.texture);var te,ae,ie,ne=function(){R.useProgram(C),R.uniform1i(R.getUniformLocation(C,"u_splitImage"),0),R.texImage2D($,0,R.RGBA,R.RGBA,R.UNSIGNED_BYTE,te),R.texParameteri($,R.TEXTURE_WRAP_S,R.REPEAT),R.texParameteri($,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),R.texParameteri($,R.TEXTURE_MIN_FILTER,R.LINEAR),R.texParameteri($,R.TEXTURE_MAG_FILTER,R.LINEAR),R.uniform1f(C.v,ae),R.uniform1f(C.vo,ie),R.useProgram(T)};if(O.shtHash&&(te=function(e){if(1>ee.length)for(var t=J.length/32,a=0;32>a;a++){ee.push([]);for(var i=0;i<t;i++)ee[a].push(E(M(J[a*t+i],1),41)*Q)}M(e[0],1),i=255*(E(M(e[1],1),41)+1)/2;var n=M(e.slice(2),2);e=[],t=[];var o=[];for(a=0;a<n.length;a++){var r,s=n[a];r=i;var h=Math.floor(s/19)%19,l=s%19;r=[s=E(Math.floor(s/361),9)*r,h=E(h,9)*r,r*=E(l,9)],e.push(r[0]),t.push(r[1]),o.push(r[2])}for(n=.03125*Math.PI,r=[],a=31;0<=a;a--)for(i=0;64>i;i++)r.push(P(e,ee[a],(i+.5)*n)),r.push(P(t,ee[a],(i+.5)*n)),r.push(P(o,ee[a],(i+.5)*n)),r.push(255);return new ImageData(new Uint8ClampedArray(r),64,32)}(O.shtHash),ae=(2+1/31)/2,ie=1-(2+1/31)/2,ne()),O.equirectangularThumbnail)if("string"==typeof O.equirectangularThumbnail){if("data:"!=O.equirectangularThumbnail.slice(0,5))throw console.log("Error: thumbnail string is not a data URI!"),{type:"config error"};(te=new Image).onload=function(){ae=1,ie=0,ne()},te.src=O.equirectangularThumbnail}else te=O.equirectangularThumbnail,ae=1,ie=0,ne();R.bindBuffer(R.ARRAY_BUFFER,G),R.vertexAttribPointer(T.vertPosLocation,3,R.FLOAT,!1,0,0),R.useProgram(T)}if(0!==(u=R.getError()))throw console.log("Error: Something went wrong with WebGL!",u),{type:"webgl error"};g()}},this.destroy=function(){if(i!==a&&(I!==a&&i.contains(I)&&i.removeChild(I),F!==a&&i.contains(F)&&i.removeChild(F)),R){var e=R.getExtension("WEBGL_lose_context");e&&e.loseContext()}},this.resize=function(){var t=e.devicePixelRatio||1;I.width=I.clientWidth*t,I.height=I.clientHeight*t,R&&(1286==R.getError()&&x(),R.viewport(0,0,R.drawingBufferWidth,R.drawingBufferHeight),"multires"!=U?R.uniform1f(T.aspectRatio,I.clientWidth/I.clientHeight):O.shtHash&&(R.useProgram(C),R.uniform1f(C.aspectRatio,I.clientWidth/I.clientHeight),R.useProgram(T)))},I&&this.resize(),this.setPose=function(e,t){e=isNaN(e)?0:Number(e),t=isNaN(t)?0:Number(t),B=0==e&&0==t?a:[e,t]},this.render=function(t,i,n,o){var r,s,h=0;if(o===a&&(o={}),o.roll&&(h=o.roll),B!==a){var l=B[0];r=B[1],s=t;var c=i,p=Math.cos(r)*Math.sin(t)*Math.sin(l)+Math.cos(t)*(Math.cos(l)*Math.cos(i)+Math.sin(r)*Math.sin(l)*Math.sin(i)),y=-Math.sin(t)*Math.sin(r)+Math.cos(t)*Math.cos(r)*Math.sin(i);t=Math.cos(r)*Math.cos(l)*Math.sin(t)+Math.cos(t)*(-Math.cos(i)*Math.sin(l)+Math.cos(l)*Math.sin(r)*Math.sin(i)),t=Math.asin(Math.max(Math.min(t,1),-1)),i=Math.atan2(y,p),l=[Math.cos(s)*(Math.sin(r)*Math.sin(l)*Math.cos(c)-Math.cos(l)*Math.sin(c)),Math.cos(s)*Math.cos(r)*Math.cos(c),Math.cos(s)*(Math.cos(l)*Math.sin(r)*Math.cos(c)+Math.sin(c)*Math.sin(l))],r=[-Math.cos(t)*Math.sin(i),Math.cos(t)*Math.cos(i)],r=Math.acos(Math.max(Math.min((l[0]*r[0]+l[1]*r[1])/(Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2])*Math.sqrt(r[0]*r[0]+r[1]*r[1])),1),-1)),0>l[2]&&(r=2*Math.PI-r),h+=r}if(o.hook&&o.hook({gl:R,program:T,previewProgram:C,imageType:U,texCoordBuffer:z,cubeVertBuf:G,cubeVertTexCoordBuf:Y,cubeVertIndBuf:q}),R||"multires"!=U&&"cubemap"!=U){if("multires"!=U)r=2*Math.atan(Math.tan(.5*n)/(R.drawingBufferWidth/R.drawingBufferHeight)),r=1/Math.tan(.5*r),R.uniform1f(T.psi,i),R.uniform1f(T.theta,t),R.uniform1f(T.rot,h),R.uniform1f(T.f,r),!0===H&&"equirectangular"==U&&(R.bindTexture(R.TEXTURE_2D,T.texture),R.texImage2D(R.TEXTURE_2D,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,O)),R.drawArrays(R.TRIANGLES,0,6);else{if((l=void 0!==O.shtHash||void 0!==O.equirectangularThumbnail)&&(R.useProgram(C),R.bindBuffer(R.ARRAY_BUFFER,z),R.vertexAttribPointer(C.texCoordLocation,2,R.FLOAT,!1,0,0),R.bindTexture(R.TEXTURE_2D,C.texture),r=2*Math.atan(Math.tan(.5*n)/(R.drawingBufferWidth/R.drawingBufferHeight)),r=1/Math.tan(.5*r),R.uniform1f(C.psi,i),R.uniform1f(C.theta,t),R.uniform1f(C.rot,h),R.uniform1f(C.f,r),R.drawArrays(R.TRIANGLES,0,6),R.bindBuffer(R.ARRAY_BUFFER,G),R.vertexAttribPointer(T.vertPosLocation,3,R.FLOAT,!1,0,0),R.useProgram(T)),c=w(n,R.drawingBufferWidth/R.drawingBufferHeight,.1,100),r=w(n,R.drawingBufferWidth/R.drawingBufferHeight,-100,100),s=g(s=new Float32Array([1,0,0,0,1,0,0,0,1]),-h,"z"),s=g(s,-t,"x"),s=g(s,i,"y"),s=new Float32Array([s[0],s[1],s[2],0,s[3],s[4],s[5],0,s[6],s[7],s[8],0,0,0,0,1]),R.uniformMatrix4fv(T.perspUniform,!1,v(c)),R.uniformMatrix4fv(T.cubeUniform,!1,v(s)),h=_(c,s),r=_(r,s),T.nodeCache.sort(d),200<T.nodeCache.length&&T.nodeCache.length>T.currentNodes.length+50)for(s=T.nodeCache.splice(200,T.nodeCache.length-200),c=0;c<s.length;c++)R.deleteTexture(s[c].texture);for(T.currentNodes=[],s=0;6>s;s++)m(h,r,c=new f(k[s],X[s],1,0,0,O.fullpath,null),t,i);for(T.currentNodes.sort(u),t=Z.length-1;0<=t;t--)-1===T.currentNodes.indexOf(Z[t].node)&&(Z[t].node.textureLoad=!1,Z.splice(t,1));if(0===Z.length)for(t=0;t<T.currentNodes.length;t++)if(!(i=T.currentNodes[t]).texture&&!i.textureLoad){i.textureLoad=!0,setTimeout(j,0,i);break}if(0<T.textureLoads.length&&T.textureLoads.shift()(!0),t=!l,!T.drawInProgress){for(T.drawInProgress=!0,t&&R.clear(R.COLOR_BUFFER_BIT),t={},i=0;i<T.currentNodes.length;i++)t[T.currentNodes[i].parentPath]===a&&(t[T.currentNodes[i].parentPath]=0),t[T.currentNodes[i].parentPath]+=!(1<T.currentNodes[i].textureLoaded);for(i=0;i<T.currentNodes.length;i++)1<T.currentNodes[i].textureLoaded&&(R.bufferData(R.ARRAY_BUFFER,T.currentNodes[i].vertices,R.STATIC_DRAW),R.bindTexture(R.TEXTURE_2D,T.currentNodes[i].texture),R.drawElements(R.TRIANGLES,6,R.UNSIGNED_SHORT,0));T.drawInProgress=!1}}if(o.returnImage!==a)return e.createImageBitmap&&"ImageBitmap"==o.returnImage?createImageBitmap(I):0==o.returnImage.toString().indexOf("image/")?I.toDataURL(o.returnImage):I.toDataURL("image/jpg",.5)}else for(o={f:"translate3d(-"+((s=N/2)+2)+"px, -"+(s+2)+"px, -"+s+"px)",b:"translate3d("+(s+2)+"px, -"+(s+2)+"px, "+s+"px) rotateX(180deg) rotateZ(180deg)",u:"translate3d(-"+(s+2)+"px, -"+s+"px, "+(s+2)+"px) rotateX(270deg)",d:"translate3d(-"+(s+2)+"px, "+s+"px, -"+(s+2)+"px) rotateX(90deg)",l:"translate3d(-"+s+"px, -"+(s+2)+"px, "+(s+2)+"px) rotateX(180deg) rotateY(90deg) rotateZ(180deg)",r:"translate3d("+s+"px, -"+(s+2)+"px, -"+(s+2)+"px) rotateY(270deg)"},i="perspective("+(n=(r=1/Math.tan(n/2))*I.clientWidth/2+"px")+") translateZ("+n+") rotateX("+t+"rad) rotateY("+i+"rad) ",n=Object.keys(o),t=0;6>t;t++)(h=F.querySelector(".pnlm-"+n[t]+"face"))&&(h.style.webkitTransform=i+o[n[t]],h.style.transform=i+o[n[t]])},this.isLoading=function(){if(R&&"multires"==U)for(var e=0;e<T.currentNodes.length;e++)if(!T.currentNodes[e].textureLoaded)return!0;return!1},this.isBaseLoaded=function(){if(6<=T.currentNodes.length){for(var e=0;6>e;e++)if(!T.currentNodes[e].textureLoaded)return!1;return!0}return!1},this.getCanvas=function(){return I};var j,Z=[],$=function(){function e(){var e=this;this.texture=this.callback=null,this.image=new Image,this.image.crossOrigin=a||"anonymous";var t=function(){T.textureLoads.push((function(t){t&&(0<e.image.width&&0<e.image.height?(t=e.image,R.bindTexture(R.TEXTURE_2D,e.texture),R.texImage2D(R.TEXTURE_2D,0,R.RGB,R.RGB,R.UNSIGNED_BYTE,t),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_MAG_FILTER,R.LINEAR),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_MIN_FILTER,R.LINEAR),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_WRAP_S,R.CLAMP_TO_EDGE),R.texParameteri(R.TEXTURE_2D,R.TEXTURE_WRAP_T,R.CLAMP_TO_EDGE),R.bindTexture(R.TEXTURE_2D,null),e.callback(e.texture,!0)):e.callback(e.texture,!1)),Z.length?(t=Z.shift(),e.loadTexture(t.src,t.texture,t.callback)):n[i++]=e}))};this.image.addEventListener("load",t),this.image.addEventListener("error",t)}function t(e,t,a,i){this.node=e,this.src=t,this.texture=a,this.callback=i}var a,i=4,n={};e.prototype.loadTexture=function(e,t,a){this.texture=t,this.callback=a,this.image.src=e};for(var o=0;o<i;o++)n[o]=new e;return function(e,o,r,s){return a=s,s=R.createTexture(),i?n[--i].loadTexture(o,s,r):Z.push(new t(e,o,s,r)),s}}();j=function(e){$(e,e.path+(O.extension?"."+O.extension:""),(function(t,a){e.texture=t,e.textureLoaded=a?2:1}),V.crossOrigin)};var K="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz#$%*+,-.:;=?@[]^_{|}~",J="Bf[ff4fff|ffff0fffffBo@Ri5xag{Jmdf2+WiefCs@Ll7+Vi]Btag6[NmdgCv=Ho9;Qk;7zWiF_GsahDy:ErE?Mn$5+SkS_AyWiD#-CuJ[Iqp6;Nnx?7*SlE$*BxR@FtPA?Jq+%7:NnF*zAzn?CwIG@Ft-Y9?IrG+vA%w:AzGR?Cx*IF@EuI,nA+$*9%Gu:A#xCR?ByJ-VB-*wA+J**9*ZBv:9%L.QD.*aB.O.v9-MF+$8,O:MG:*OD;a:UB:IO:n9:Q:KJ;#IG=u-KE=Hs:MC?T:IO=wEL?#%FJ@K**FI@Y;HV=pDU?*sCS@S.uCR[m;Hp=VDq?*SCs@s.QCt[r:Iw=OEz?#IF$@#*HF%@u:K$;KI+=uEK-=*sCM:?w:M+:HO.;aCU;:%OCn?:z.Q..Ha;.ODv?-yFG$@,$-V;-Hw=+JH*?*lBP:?%%,n=+J*?%GQ:=#NCt?;y++v=%O:=zGt?:xHI,@-u,*z=zX?:wI+@,tEY??%r-$*;xt@,tP=?$qG%[:xn.#-:u$[%qp];xnN?[*sl.y:-r-?yn$^+sks_=yoi:v=*o?;uk;[zoi,_+skh:s@zl[+pi];tkg][xmhg;o@ti^xkg{$mhf|+oigf;f[ff_fff|ffff~fffff",Q=3.317,ee=[]}var n="attribute vec2 a_texCoord;varying vec2 v_texCoord;void main() {gl_Position = vec4(a_texCoord, 0.0, 1.0);v_texCoord = a_texCoord;}",o="attribute vec3 a_vertCoord;attribute vec2 a_texCoord;uniform mat4 u_cubeMatrix;uniform mat4 u_perspMatrix;varying mediump vec2 v_texCoord;void main(void) {gl_Position = u_perspMatrix * u_cubeMatrix * vec4(a_vertCoord, 1.0);v_texCoord = a_texCoord;}",r="precision highp float;\nuniform float u_aspectRatio;\nuniform float u_psi;\nuniform float u_theta;\nuniform float u_f;\nuniform float u_h;\nuniform float u_v;\nuniform float u_vo;\nuniform float u_rot;\nconst float PI = 3.14159265358979323846264;\nuniform sampler2D u_image0;\nuniform sampler2D u_image1;\nuniform bool u_splitImage;\nuniform samplerCube u_imageCube;\nvarying vec2 v_texCoord;\nuniform vec4 u_backgroundColor;\nvoid main() {\nfloat x = v_texCoord.x * u_aspectRatio;\nfloat y = v_texCoord.y;\nfloat sinrot = sin(u_rot);\nfloat cosrot = cos(u_rot);\nfloat rot_x = x * cosrot - y * sinrot;\nfloat rot_y = x * sinrot + y * cosrot;\nfloat sintheta = sin(u_theta);\nfloat costheta = cos(u_theta);\nfloat a = u_f * costheta - rot_y * sintheta;\nfloat root = sqrt(rot_x * rot_x + a * a);\nfloat lambda = atan(rot_x / root, a / root) + u_psi;\nfloat phi = atan((rot_y * costheta + u_f * sintheta) / root);",s=r+"float cosphi = cos(phi);\ngl_FragColor = textureCube(u_imageCube, vec3(cosphi*sin(lambda), sin(phi), cosphi*cos(lambda)));\n}",h=r+"lambda = mod(lambda + PI, PI * 2.0) - PI;\nvec2 coord = vec2(lambda / PI, phi / (PI / 2.0));\nif(coord.x < -u_h || coord.x > u_h || coord.y < -u_v + u_vo || coord.y > u_v + u_vo)\ngl_FragColor = u_backgroundColor;\nelse {\nif(u_splitImage) {\nif(coord.x < 0.0)\ngl_FragColor = texture2D(u_image0, vec2((coord.x + u_h) / u_h, (-coord.y + u_v + u_vo) / (u_v * 2.0)));\nelse\ngl_FragColor = texture2D(u_image1, vec2((coord.x + u_h) / u_h - 1.0, (-coord.y + u_v + u_vo) / (u_v * 2.0)));\n} else {\ngl_FragColor = texture2D(u_image0, vec2((coord.x + u_h) / (u_h * 2.0), (-coord.y + u_v + u_vo) / (u_v * 2.0)));\n}\n}\n}",l="varying mediump vec2 v_texCoord;uniform sampler2D u_sampler;void main(void) {gl_FragColor = texture2D(u_sampler, v_texCoord);}";return{renderer:function(e,t,a,n){return new i(e,t)}}}(window,document),window.pannellum=function(e,t,a){function i(i,n){function o(){if((c=t.createElement("div")).innerHTML="\x3c!--[if lte IE 9]><i></i><![endif]--\x3e",1==c.getElementsByTagName("i").length)h();else{var i;if(re=J.hfov,se=J.pitch,"cubemap"==J.type){for(ie=[],c=0;6>c;c++)ie.push(new Image),ie[c].crossOrigin=J.crossOrigin;He.load.lbox.style.display="block",He.load.lbar.style.display="none"}else if("multires"==J.type)c=JSON.parse(JSON.stringify(J.multiRes)),J.basePath&&J.multiRes.basePath&&!/^(?:[a-z]+:)?\/\//i.test(J.multiRes.basePath)?c.basePath=J.basePath+J.multiRes.basePath:J.multiRes.basePath?c.basePath=J.multiRes.basePath:J.basePath&&(c.basePath=J.basePath),ie=c;else if(!0===J.dynamic)ie=J.panorama;else{if(J.panorama===a)return void h(J.strings.noPanoramaError);ie=new Image}if("cubemap"==J.type)for(var n=6,o=function(){0===--n&&s()},l=function(e){var a=t.createElement("a");a.href=e.target.src,a.textContent=a.href,h(J.strings.fileAccessError.replace("%s",a.outerHTML))},c=0;c<ie.length;c++)"null"==(i=J.cubeMap[c])?(console.log("Will use background instead of missing cubemap face "+c),o()):(J.basePath&&!r(i)&&(i=J.basePath+i),ie[c].onload=o,ie[c].onerror=l,ie[c].src=$(i));else if("multires"==J.type)s();else if(i="",J.basePath&&(i=J.basePath),!0!==J.dynamic){if(J.panorama instanceof Image||J.panorama instanceof ImageData||e.ImageBitmap&&J.panorama instanceof ImageBitmap)return ie=J.panorama,void s();i=r(J.panorama)?J.panorama:i+J.panorama,ie.onload=function(){e.URL.revokeObjectURL(this.src),s()},(le=new XMLHttpRequest).onloadend=function(){if(200!=le.status){var n=t.createElement("a");n.href=i,n.textContent=n.href,h(J.strings.fileAccessError.replace("%s",n.outerHTML))}else(function(i,n){var o=new FileReader;o.addEventListener("loadend",(function(){var r=o.result;navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 8_/)&&((0>(c=r.indexOf("ÿÂ"))||65536<c)&&h(J.strings.iOS8WebGLError));if(-1<(c=r.indexOf("<x:xmpmeta"))&&!0!==J.ignoreGPanoXMP){var s=r.substring(c,r.indexOf("</x:xmpmeta>")+12),l=function(e){var t;return 0<=s.indexOf(e+'="')?t=(t=s.substring(s.indexOf(e+'="')+e.length+2)).substring(0,t.indexOf('"')):0<=s.indexOf(e+">")&&(t=(t=s.substring(s.indexOf(e+">")+e.length+1)).substring(0,t.indexOf("<"))),t!==a?Number(t):null},c=(r=l("GPano:FullPanoWidthPixels"),l("GPano:CroppedAreaImageWidthPixels")),d=l("GPano:FullPanoHeightPixels"),u=l("GPano:CroppedAreaImageHeightPixels"),f=l("GPano:CroppedAreaTopPixels"),m=l("GPano:PoseHeadingDegrees"),p=l("GPano:PosePitchDegrees"),g=l("GPano:PoseRollDegrees"),v=l("GPano:InitialViewPitchDegrees"),w=l("GPano:InitialViewHeadingDegrees");l=l("GPano:InitialHorizontalFOVDegrees");null!==r&&null!==c&&null!==d&&null!==u&&null!==f&&(0>Ae.indexOf("haov")&&(J.haov=c/r*360),0>Ae.indexOf("vaov")&&(J.vaov=u/d*180),0>Ae.indexOf("vOffset")&&(J.vOffset=-180*((f+u/2)/d-.5)),null!==m&&0>Ae.indexOf("northOffset")&&(J.northOffset=m,!1!==J.compass&&(J.compass=!0)),null!==p&&null!==g&&(0>Ae.indexOf("horizonPitch")&&(J.horizonPitch=p),0>Ae.indexOf("horizonRoll")&&(J.horizonRoll=g)),null!=v&&0>Ae.indexOf("pitch")&&(J.pitch=v),null!=w&&0>Ae.indexOf("yaw")&&(J.yaw=w),null!=l&&0>Ae.indexOf("hfov")&&(J.hfov=l))}ie.src=e.URL.createObjectURL(i),ie.onerror=function(){(e.fetch?e.fetch(t.location.href).then((function(e){return e.headers.get("Content-Security-Policy")})):null).then((function(e){e&&e.split(";").find((function(e){if(e=e.match(/img-src(.*)/))return!e[1].includes("blob")}))&&(console.log("CSP blocks blobs; reverting to URL."),ie.crossOrigin=J.crossOrigin,ie.src=n)}))}})),o.readAsBinaryString!==a?o.readAsBinaryString(i):o.readAsText(i)})(this.response,i),He.load.msg.innerHTML=""},le.onprogress=function(e){var t,a;e.lengthComputable?(He.load.lbarFill.style.width=e.loaded/e.total*100+"%",1e6<e.total?(t="MB",a=(e.loaded/1e6).toFixed(2),e=(e.total/1e6).toFixed(2)):1e3<e.total?(t="kB",a=(e.loaded/1e3).toFixed(1),e=(e.total/1e3).toFixed(1)):(t="B",a=e.loaded,e=e.total),He.load.msg.innerHTML=a+" / "+e+" "+t):(He.load.lbox.style.display="block",He.load.lbar.style.display="none")};try{le.open("GET",i,!0)}catch(e){h(J.strings.malformedURLError)}le.responseType="blob",le.setRequestHeader("Accept","image/*,*/*;q=0.9"),le.withCredentials="use-credentials"===J.crossOrigin,le.send()}J.draggable&&Ne.classList.add("pnlm-grab"),Ne.classList.remove("pnlm-grabbing"),Le=!0===J.dynamicUpdate,J.dynamic&&Le&&(ie=J.panorama,s())}}function r(e){return/^(?:[a-z]+:)?\/\//i.test(e)||"/"==e[0]||"blob:"==e.slice(0,5)}function s(){Q||(Q=new libpannellum.renderer(Fe)),be||(be=!0,ke.addEventListener("mousedown",u,!1),t.addEventListener("mousemove",p,!1),t.addEventListener("mouseup",g,!1),J.mouseZoom&&(Ne.addEventListener("mousewheel",E,!1),Ne.addEventListener("DOMMouseScroll",E,!1)),J.doubleClickZoom&&ke.addEventListener("dblclick",f,!1),i.addEventListener("mozfullscreenchange",z,!1),i.addEventListener("webkitfullscreenchange",z,!1),i.addEventListener("msfullscreenchange",z,!1),i.addEventListener("fullscreenchange",z,!1),"function"==typeof ResizeObserver?(he=new ResizeObserver(A)).observe(i):(e.addEventListener("resize",A,!1),e.addEventListener("orientationchange",A,!1)),J.disableKeyboardCtrl||(i.addEventListener("keydown",M,!1),i.addEventListener("keyup",I,!1),i.addEventListener("blur",P,!1)),t.addEventListener("mouseleave",g,!1),""===t.documentElement.style.pointerAction&&""===t.documentElement.style.touchAction?(ke.addEventListener("pointerdown",y,!1),ke.addEventListener("pointermove",b,!1),ke.addEventListener("pointerup",x,!1),ke.addEventListener("pointerleave",x,!1)):(ke.addEventListener("touchstart",v,!1),ke.addEventListener("touchmove",w,!1),ke.addEventListener("touchend",_,!1)),e.navigator.pointerEnabled&&(i.style.touchAction="none")),function(){try{var e={};J.horizonPitch!==a&&(e.horizonPitch=J.horizonPitch*Math.PI/180),J.horizonRoll!==a&&(e.horizonRoll=J.horizonRoll*Math.PI/180),J.backgroundColor!==a&&(e.backgroundColor=J.backgroundColor),Q.init(ie,J.type,J.dynamic,J.haov*Math.PI/180,J.vaov*Math.PI/180,J.vOffset*Math.PI/180,N,e),!0!==J.dynamic&&(ie=a)}catch(e){if("webgl error"==e.type||"no webgl"==e.type)h();else{if("webgl size error"!=e.type)throw h(J.strings.unknownError),e;h(J.strings.textureSizeError.replace("%s",e.width).replace("%s",e.maxWidth))}}}(),Y(J.hfov),setTimeout((function(){}),500)}function h(e){e===a&&(e=J.strings.genericWebGLError),He.errorMsg.innerHTML="<p>"+e+"</p>",Ge.load.style.display="none",He.load.box.style.display="none",He.errorMsg.style.display="table",ye=!0,ae=a,Fe.style.display="none",K("error",e)}function l(e){He.interactionMsg.style.opacity=1,He.interactionMsg.innerHTML="<p>"+e+"</p>",He.interactionMsg.style.display="table",K("messageshown"),clearTimeout(He.interactionMsg.timeout),He.interactionMsg.removeEventListener("transitionend",c),He.interactionMsg.timeout=setTimeout((function(){He.interactionMsg.style.opacity=0,He.interactionMsg.addEventListener("transitionend",c)}),2e3)}function c(){He.interactionMsg.style.opacity=0,He.interactionMsg.style.display="none",K("messagecleared")}function d(e){var t=i.getBoundingClientRect(),a={};return a.x=(e.clientX||e.pageX)-t.left,a.y=(e.clientY||e.pageY)-t.top,a}function u(e){if(e.preventDefault(),i.focus(),ae&&J.draggable&&!J.draggingHotSpot){var t=d(e);if(J.hotSpotDebug){var a=m(e);console.log("Pitch: "+a[0]+", Yaw: "+a[1]+", Center Pitch: "+J.pitch+", Center Yaw: "+J.yaw+", HFOV: "+J.hfov)}q(),W(),J.roll=0,xe.hfov=0,de=!0,ue=Date.now(),fe=t.x,me=t.y,ge=J.yaw,ve=J.pitch,Ne.classList.add("pnlm-grabbing"),Ne.classList.remove("pnlm-grab"),K("mousedown",e),L()}}function f(e){J.minHfov===J.hfov?ce.setHfov(re,1e3):(e=m(e),ce.lookAt(e[0],e[1],J.minHfov,1e3))}function m(e){var t=d(e),a=(e=Q.getCanvas()).clientWidth,i=e.clientHeight;e=t.x/a*2-1;i=(1-t.y/i*2)*i/a;var n=1/Math.tan(J.hfov*Math.PI/360),o=Math.sin(J.pitch*Math.PI/180),r=Math.cos(J.pitch*Math.PI/180);t=n*r-i*o,a=Math.sqrt(e*e+t*t),i=180*Math.atan((i*r+n*o)/a)/Math.PI;return-180>(e=180*Math.atan2(e/a,t/a)/Math.PI+J.yaw)&&(e+=360),180<e&&(e-=360),[i,e]}function p(e){if(te)k(te,e);else if(de&&ae){ue=Date.now();var t=(a=Q.getCanvas()).clientWidth,a=a.clientHeight;e=d(e);var i=180*(Math.atan(fe/t*2-1)-Math.atan(e.x/t*2-1))/Math.PI*J.hfov/90+ge;xe.yaw=(i-J.yaw)%360*.2,J.yaw=i,t=360*Math.atan(Math.tan(J.hfov/360*Math.PI)*a/t)/Math.PI,t=180*(Math.atan(e.y/a*2-1)-Math.atan(me/a*2-1))/Math.PI*t/90+ve,xe.pitch=.2*(t-J.pitch),J.pitch=t}}function g(e){te&&te.dragHandlerFunc&&te.dragHandlerFunc(e,te.dragHandlerArgs),te=null,de&&(de=!1,15<Date.now()-ue&&(xe.pitch=xe.yaw=0),Ne.classList.add("pnlm-grab"),Ne.classList.remove("pnlm-grabbing"),ue=Date.now(),K("mouseup",e))}function v(e){if(ae&&J.draggable&&!te){q(),W(),J.roll=0,xe.hfov=0;var t=d(e.targetTouches[0]);if(fe=t.x,me=t.y,2==e.targetTouches.length){var a=d(e.targetTouches[1]);fe+=.5*(a.x-t.x),me+=.5*(a.y-t.y),pe=Math.sqrt((t.x-a.x)*(t.x-a.x)+(t.y-a.y)*(t.y-a.y))}de=!0,ue=Date.now(),ge=J.yaw,ve=J.pitch,K("touchstart",e),L()}}function w(e){if(J.draggable&&(J.dragConfirm||e.preventDefault(),ae&&(ue=Date.now()),de&&ae)){var t=(n=d(e.targetTouches[0])).x,a=n.y;if(2==e.targetTouches.length&&-1!=pe){var i=d(e.targetTouches[1]),n=(t=t+.5*(i.x-n.x),a=a+.5*(i.y-n.y),Math.sqrt((n.x-i.x)*(n.x-i.x)+(n.y-i.y)*(n.y-i.y)));Y(J.hfov+.1*(pe-n)),pe=n}n=J.hfov/360*J.touchPanSpeedCoeffFactor,_e||"both"!=J.dragConfirm&&"yaw"!=J.dragConfirm||2==e.targetTouches.length?(t=(fe-t)*n+ge,xe.yaw=(t-J.yaw)%360*.2,J.yaw=t):fe!=t&&("yaw"==J.dragConfirm?l(J.strings.twoTouchXActivate):l(J.strings.twoTouchActivate)),_e||"both"!=J.dragConfirm&&"pitch"!=J.dragConfirm||2==e.targetTouches.length?(a=(a-me)*n+ve,xe.pitch=.2*(a-J.pitch),J.pitch=a):me!=a&&("pitch"==J.dragConfirm?l(J.strings.twoTouchYActivate):l(J.strings.twoTouchActivate)),"yaw"!=J.dragConfirm&&"pitch"!=J.dragConfirm&&"both"!=J.dragConfirm||2!=e.targetTouches.length||(c(),e.preventDefault())}}function _(){te=null,de=!1,150<Date.now()-ue&&(xe.pitch=xe.yaw=0),pe=-1,ue=Date.now(),K("touchend",event)}function y(e){"touch"==e.pointerType&&ae&&J.draggable&&(Ve.push(e.pointerId),Xe.push({clientX:e.clientX,clientY:e.clientY}),e.targetTouches=Xe,v(e),e.preventDefault())}function b(e){if("touch"==e.pointerType)if(te)k(te,e);else if(J.draggable)for(var t=0;t<Ve.length;t++)if(e.pointerId==Ve[t]){Xe[t].clientX=e.clientX,Xe[t].clientY=e.clientY,e.targetTouches=Xe,w(e),e.preventDefault();break}}function x(e){if(te&&te.dragHandlerFunc&&te.dragHandlerFunc(e,te.dragHandlerArgs),te=null,"touch"==e.pointerType){for(var t=!1,i=0;i<Ve.length;i++)e.pointerId==Ve[i]&&(Ve[i]=a),Ve[i]&&(t=!0);t||(Ve=[],Xe=[],_()),e.preventDefault()}}function E(e){ae&&("fullscreenonly"!=J.mouseZoom||_e)&&(_e||"ctrl"!=J.mouseZoom||e.ctrlKey?(c(),e.preventDefault(),q(),ue=Date.now(),e.wheelDeltaY?(Y(J.hfov-.05*e.wheelDeltaY),xe.hfov=0>e.wheelDelta?1:-1):e.wheelDelta?(Y(J.hfov-.05*e.wheelDelta),xe.hfov=0>e.wheelDelta?1:-1):e.detail&&(Y(J.hfov+1.5*e.detail),xe.hfov=0<e.detail?1:-1),L()):(e=-1!=navigator.platform.indexOf("Mac")?"control":"ctrl",l(J.strings.ctrlZoomActivate.replace("%s",'<kbd class="pnlm-outline">'+e+"</kbd>"))))}function M(e){q(),ue=Date.now(),W(),J.roll=0;var t=e.which||e.keycode;0>J.capturedKeyNumbers.indexOf(t)||!(_e||16!=t&&17!=t||"ctrl"!=J.mouseZoom)||(e.preventDefault(),27==t?_e&&H():T(t,!0))}function P(){for(var e=0;10>e;e++)we[e]=!1}function I(e){var t=e.which||e.keycode;0>J.capturedKeyNumbers.indexOf(t)||(e.preventDefault(),T(t,!1))}function T(e,t){var a=!1;switch(e){case 109:case 189:case 17:case 173:we[0]!=t&&(a=!0),we[0]=t;break;case 107:case 187:case 16:case 61:we[1]!=t&&(a=!0),we[1]=t;break;case 38:we[2]!=t&&(a=!0),we[2]=t;break;case 87:we[6]!=t&&(a=!0),we[6]=t;break;case 40:we[3]!=t&&(a=!0),we[3]=t;break;case 83:we[7]!=t&&(a=!0),we[7]=t;break;case 37:we[4]!=t&&(a=!0),we[4]=t;break;case 65:we[8]!=t&&(a=!0),we[8]=t;break;case 39:we[5]!=t&&(a=!0),we[5]=t;break;case 68:we[9]!=t&&(a=!0),we[9]=t}a&&t&&(ne="undefined"!=typeof performance&&performance.now()?performance.now():Date.now(),L())}function R(e){var t=Te[e],a=Math.min(1,Math.max((Date.now()-t.startTime)/1e3/(t.duration/1e3),0));a=t.startPosition+J.animationTimingFunction(a)*(t.endPosition-t.startPosition);(t.endPosition>t.startPosition&&a>=t.endPosition||t.endPosition<t.startPosition&&a<=t.endPosition||t.endPosition===t.startPosition)&&(a=t.endPosition,xe[e]=0,delete Te[e]),J[e]=a}function A(){z("resize")}function L(){Ee||(Ee=!0,C())}function C(){if(!Se)if(function(){var e;if(ae){var t=Q.getCanvas();!1!==J.autoRotate&&(360<J.yaw?J.yaw-=360:-360>J.yaw&&(J.yaw+=360)),e=J.yaw;var i=0;if(J.avoidShowingBackground){var n=J.hfov/2,o=180*Math.atan2(Math.tan(n/180*Math.PI),t.width/t.height)/Math.PI;J.vaov>J.haov?Math.min(Math.cos((J.pitch-n)/180*Math.PI),Math.cos((J.pitch+n)/180*Math.PI)):i=n*(1-Math.min(Math.cos((J.pitch-o)/180*Math.PI),Math.cos((J.pitch+o)/180*Math.PI)))}o=-180;var r=180;360>(n=J.maxYaw-J.minYaw)&&(o=J.minYaw+J.hfov/2+i,r=J.maxYaw-J.hfov/2-i,n<J.hfov&&(o=r=(o+r)/2),J.yaw=Math.max(o,Math.min(r,J.yaw))),!1===J.autoRotate&&(360<J.yaw?J.yaw-=360:-360>J.yaw&&(J.yaw+=360)),!1!==J.autoRotate&&e!=J.yaw&&ne!==a&&(J.autoRotate*=-1),e=2*Math.atan(Math.tan(J.hfov/180*Math.PI*.5)/(t.width/t.height))/Math.PI*180,t=J.minPitch+e/2,i=J.maxPitch-e/2,J.maxPitch-J.minPitch<e&&(t=i=(t+i)/2),isNaN(t)&&(t=-90),isNaN(i)&&(i=90),J.pitch=Math.max(t,Math.min(i,J.pitch)),Q.render(J.pitch*Math.PI/180,J.yaw*Math.PI/180,J.hfov*Math.PI/180,{roll:J.roll*Math.PI/180}),J.hotSpots.forEach(B),J.compass&&(qe.style.transform="rotate("+(-J.yaw-J.northOffset)+"deg)",qe.style.webkitTransform="rotate("+(-J.yaw-J.northOffset)+"deg)")}}(),oe&&clearTimeout(oe),de||!0===Me)requestAnimationFrame(C);else if(we[0]||we[1]||we[2]||we[3]||we[4]||we[5]||we[6]||we[7]||we[8]||we[9]||J.autoRotate||Te.pitch||Te.yaw||Te.hfov||.01<Math.abs(xe.yaw)||.01<Math.abs(xe.pitch)||.01<Math.abs(xe.hfov))(function(){if(ae){var e,t=!1,i=J.pitch,n=J.yaw,o=J.hfov;e="undefined"!=typeof performance&&performance.now()?performance.now():Date.now(),ne===a&&(ne=e);var r=(e-ne)*J.hfov/1200;if(r=Math.min(r,10),we[0]&&!0===J.keyboardZoom&&(Y(J.hfov+(.8*xe.hfov+.4)*r),t=!0),we[1]&&!0===J.keyboardZoom&&(Y(J.hfov+(.8*xe.hfov-.2)*r),t=!0),(we[2]||we[6])&&(J.pitch+=(.8*xe.pitch+.2)*r,t=!0),(we[3]||we[7])&&(J.pitch+=(.8*xe.pitch-.2)*r,t=!0),(we[4]||we[8])&&(J.yaw+=(.8*xe.yaw-.2)*r,t=!0),(we[5]||we[9])&&(J.yaw+=(.8*xe.yaw+.2)*r,t=!0),t&&(ue=Date.now()),J.autoRotate){if(.001<e-ne){t=(e-ne)/1e3;var s=(xe.yaw/t*r-.2*J.autoRotate)*t;s=(0<-J.autoRotate?1:-1)*Math.min(Math.abs(J.autoRotate*t),Math.abs(s)),J.yaw+=s}J.autoRotateStopDelay&&(J.autoRotateStopDelay-=e-ne,0>=J.autoRotateStopDelay&&(J.autoRotateStopDelay=!1,Ie=J.autoRotate,J.autoRotate=0))}Te.pitch&&(R("pitch"),i=J.pitch),Te.yaw&&(R("yaw"),n=J.yaw),Te.hfov&&(R("hfov"),o=J.hfov),0<r&&!J.autoRotate&&(t=1-J.friction,we[4]||we[5]||we[8]||we[9]||Te.yaw||(J.yaw+=xe.yaw*r*t),we[2]||we[3]||we[6]||we[7]||Te.pitch||(J.pitch+=xe.pitch*r*t),we[0]||we[1]||Te.hfov||(90<J.hfov&&(t*=1-(J.hfov-90)/90),Y(J.hfov+xe.hfov*r*t))),ne=e,0<r&&(xe.yaw=.8*xe.yaw+(J.yaw-n)/r*.2,xe.pitch=.8*xe.pitch+(J.pitch-i)/r*.2,xe.hfov=.8*xe.hfov+(J.hfov-o)/r*.2,i=J.autoRotate?Math.abs(J.autoRotate):5,xe.yaw=Math.min(i,Math.max(xe.yaw,-i)),xe.pitch=Math.min(i,Math.max(xe.pitch,-i)),xe.hfov=Math.min(i,Math.max(xe.hfov,-i))),we[0]&&we[1]&&(xe.hfov=0),(we[2]||we[6])&&(we[3]||we[7])&&(xe.pitch=0),(we[4]||we[8])&&(we[5]||we[9])&&(xe.yaw=0)}})(),0<=J.autoRotateInactivityDelay&&Ie&&Date.now()-ue>J.autoRotateInactivityDelay&&!J.autoRotate&&(J.autoRotate=Ie,ce.lookAt(se,a,re,3e3)),requestAnimationFrame(C);else if(Q&&(Q.isLoading()||!0===J.dynamic&&Le))requestAnimationFrame(C);else{ce.getPitch&&ce.getYaw&&ce.getHfov&&K("animatefinished",{pitch:ce.getPitch(),yaw:ce.getYaw(),hfov:ce.getHfov()}),Ee=!1,ne=a;var e=J.autoRotateInactivityDelay-(Date.now()-ue);0<e?oe=setTimeout((function(){J.autoRotate=Ie,ce.lookAt(se,a,re,3e3),L()}),e):0<=J.autoRotateInactivityDelay&&Ie&&(J.autoRotate=Ie,ce.lookAt(se,a,re,3e3),L())}}function S(e,t,a,i){this.w=e,this.x=t,this.y=a,this.z=i}function D(t){var a;a=t.alpha;var i=t.beta;t=t.gamma,i=[i?i*Math.PI/180/2:0,t?t*Math.PI/180/2:0,a?a*Math.PI/180/2:0],a=[Math.cos(i[0]),Math.cos(i[1]),Math.cos(i[2])],i=[Math.sin(i[0]),Math.sin(i[1]),Math.sin(i[2])],a=(a=new S(a[0]*a[1]*a[2]-i[0]*i[1]*i[2],i[0]*a[1]*a[2]-a[0]*i[1]*i[2],a[0]*i[1]*a[2]+i[0]*a[1]*i[2],a[0]*a[1]*i[2]+i[0]*i[1]*a[2])).multiply(new S(Math.sqrt(.5),-Math.sqrt(.5),0,0)),i=e.orientation?-e.orientation*Math.PI/180/2:0,a=a.multiply(new S(Math.cos(i),0,-Math.sin(i),0)).toEulerAngles(),"number"==typeof Me&&10>Me?Me+=1:10===Me?(Pe=a[2]/Math.PI*180+J.yaw,Me=!0,requestAnimationFrame(C)):(J.pitch=a[0]/Math.PI*180,J.roll=-a[1]/Math.PI*180,J.yaw=-a[2]/Math.PI*180+Pe)}function N(){if(J.sceneFadeDuration&&Q.fadeImg!==a){Q.fadeImg.style.opacity=0;var e=Q.fadeImg;delete Q.fadeImg,setTimeout((function(){Fe.removeChild(e),K("scenechangefadedone")}),J.sceneFadeDuration)}qe.style.display=J.compass?"inline":"none",Ce||(J.hotSpots?(J.hotSpots=J.hotSpots.sort((function(e,t){return e.pitch<t.pitch})),J.hotSpots.forEach(F)):J.hotSpots=[],Ce=!0,J.hotSpots.forEach(B)),He.load.box.style.display="none",ee!==a&&(Fe.removeChild(ee),ee=a),ae=!0,L(),K("load")}function F(e){e.pitch=Number(e.pitch)||0,e.yaw=Number(e.yaw)||0;var a=t.createElement("div");a.className="pnlm-hotspot-base",a.className=e.cssClass?a.className+" "+e.cssClass:a.className+" pnlm-hotspot pnlm-sprite pnlm-"+Z(e.type);var i,n=t.createElement("span");if(e.text&&(n.innerHTML=Z(e.text)),e.video){i=t.createElement("video");var o=e.video;J.basePath&&!r(o)&&(o=J.basePath+o),i.src=$(o),i.controls=!0,i.style.width=e.width+"px",Ne.appendChild(a),n.appendChild(i)}else if(e.image){o=e.image,J.basePath&&!r(o)&&(o=J.basePath+o),(i=t.createElement("a")).href=$(e.URL?e.URL:o,!0),J.targetBlank&&(i.target="_blank",i.rel="noopener"),n.appendChild(i);var s=t.createElement("img");s.src=$(o),s.style.width=e.width+"px",s.style.paddingTop="5px",Ne.appendChild(a),i.appendChild(s),n.style.maxWidth="initial"}else if(e.URL){if((i=t.createElement("a")).href=$(e.URL,!0),e.attributes)for(o in e.attributes)i.setAttribute(o,e.attributes[o]);else J.targetBlank&&(i.target="_blank",i.rel="noopener");Ne.appendChild(i),a.className+=" pnlm-pointer",n.className+=" pnlm-pointer",i.appendChild(a)}else e.sceneId&&(a.onclick=function(){return a.clicked||(a.clicked=!0,X(e.sceneId,e.targetPitch,e.targetYaw,e.targetHfov)),!1},a.className+=" pnlm-pointer",n.className+=" pnlm-pointer"),Ne.appendChild(a);e.createTooltipFunc?e.createTooltipFunc(a,e.createTooltipArgs):(e.text||e.video||e.image)&&(a.classList.add("pnlm-tooltip"),a.appendChild(n),n.style.width=n.scrollWidth-20+"px",n.style.marginLeft=-(n.scrollWidth-a.offsetWidth)/2+"px",n.style.marginTop=-n.scrollHeight-12+"px"),e.clickHandlerFunc&&(a.addEventListener("click",(function(t){e.clickHandlerFunc(t,e.clickHandlerArgs)}),"false"),""===t.documentElement.style.pointerAction&&""===t.documentElement.style.touchAction?a.addEventListener("pointerup",(function(t){e.clickHandlerFunc(t,e.clickHandlerArgs)}),!1):a.addEventListener("touchend",(function(t){e.clickHandlerFunc(t,e.clickHandlerArgs)}),!1),a.className+=" pnlm-pointer",n.className+=" pnlm-pointer"),e.draggable&&(a.addEventListener("mousedown",(function(t){e.dragHandlerFunc&&e.dragHandlerFunc(t,e.dragHandlerArgs),te=e})),""===t.documentElement.style.pointerAction&&""===t.documentElement.style.touchAction&&a.addEventListener("pointerdown",(function(t){e.dragHandlerFunc&&e.dragHandlerFunc(t,e.dragHandlerArgs),te=e})),a.addEventListener("touchmove",(function(t){k(e,t.targetTouches[0])})),a.addEventListener("touchend",(function(t){e.dragHandlerFunc&&e.dragHandlerFunc(t,e.dragHandlerArgs),te=null}))),e.div=a}function k(e,t){var a=m(t);e.pitch=a[0],e.yaw=a[1],B(e)}function B(e){var t=Math.sin(e.pitch*Math.PI/180),a=Math.cos(e.pitch*Math.PI/180),i=Math.sin(J.pitch*Math.PI/180),n=Math.cos(J.pitch*Math.PI/180),o=Math.cos((-e.yaw+J.yaw)*Math.PI/180),r=t*i+a*o*n;if(90>=e.yaw&&-90<e.yaw&&0>=r||(90<e.yaw||-90>=e.yaw)&&0>=r)e.div.style.visibility="hidden";else{var s=Math.sin((-e.yaw+J.yaw)*Math.PI/180),h=Math.tan(J.hfov*Math.PI/360);e.div.style.visibility="visible";var l=(c=Q.getCanvas()).clientWidth,c=c.clientHeight;t=[-l/h*s*a/r/2,-l/h*(t*n-a*o*i)/r/2],a=Math.sin(J.roll*Math.PI/180),i=Math.cos(J.roll*Math.PI/180);(t=[t[0]*i-t[1]*a,t[0]*a+t[1]*i])[0]+=(l-e.div.offsetWidth)/2,t[1]+=(c-e.div.offsetHeight)/2,l="translate("+t[0]+"px, "+t[1]+"px) translateZ(9999px) rotate("+J.roll+"deg)",e.scale&&(l+=" scale("+re/J.hfov/r+")"),e.div.style.webkitTransform=l,e.div.style.MozTransform=l,e.div.style.transform=l}}function O(e){J={};var t,a,i="haov vaov vOffset northOffset horizonPitch horizonRoll".split(" ");for(t in Ae=[],De)De.hasOwnProperty(t)&&(J[t]=De[t]);for(t in n.default)if(n.default.hasOwnProperty(t))if("strings"==t)for(a in n.default.strings)n.default.strings.hasOwnProperty(a)&&(J.strings[a]=Z(n.default.strings[a]));else J[t]=n.default[t],0<=i.indexOf(t)&&Ae.push(t);if(null!==e&&""!==e&&n.scenes&&n.scenes[e]){var o=n.scenes[e];for(t in o)if(o.hasOwnProperty(t))if("strings"==t)for(a in o.strings)o.strings.hasOwnProperty(a)&&(J.strings[a]=Z(o.strings[a]));else J[t]=o[t],0<=i.indexOf(t)&&Ae.push(t);J.scene=e}for(t in n)if(n.hasOwnProperty(t))if("strings"==t)for(a in n.strings)n.strings.hasOwnProperty(a)&&(J.strings[a]=Z(n.strings[a]));else J[t]=n[t],0<=i.indexOf(t)&&Ae.push(t)}function U(e){if((e=e||!1)&&"preview"in J){var i=J.preview;J.basePath&&!r(i)&&(i=J.basePath+i),(ee=t.createElement("div")).className="pnlm-preview-img",ee.style.backgroundImage="url('"+$(i).replace(/"/g,"%22").replace(/'/g,"%27")+"')",Fe.appendChild(ee)}i=J.title;var n=J.author;for(var s in e&&("previewTitle"in J&&(J.title=J.previewTitle),"previewAuthor"in J&&(J.author=J.previewAuthor)),J.hasOwnProperty("title")||(He.title.innerHTML=""),J.hasOwnProperty("author")||(He.author.innerHTML=""),J.hasOwnProperty("title")||J.hasOwnProperty("author")||(He.container.style.display="none"),J.targetBlank&&(Oe.rel="noopener",Oe.target="_blank"),Ge.load.innerHTML="<div><p>"+J.strings.loadButtonLabel+"</p></div>",He.load.boxp.innerHTML=J.strings.loadingLabel,J)if(J.hasOwnProperty(s))switch(s){case"title":He.title.innerHTML=Z(J[s]),He.container.style.display="inline";break;case"author":var h=Z(J[s]);J.authorURL&&((h=t.createElement("a")).href=$(J.authorURL,!0),J.targetBlank&&(h.target="_blank",h.rel="noopener"),h.innerHTML=Z(J[s]),h=h.outerHTML),He.author.innerHTML=J.strings.bylineLabel.replace("%s",h),He.container.style.display="inline";break;case"hfov":Y(Number(J[s]));break;case"autoLoad":!0===J[s]&&Q===a&&(He.load.box.style.display="inline",Ge.load.style.display="none",o());break;case"showZoomCtrl":Ge.zoom.style.display=J[s]&&0!=J.showControls?"block":"none";break;case"showFullscreenCtrl":Ge.fullscreen.style.display=J[s]&&0!=J.showControls&&("fullscreen"in t||"mozFullScreen"in t||"webkitIsFullScreen"in t||"msFullscreenElement"in t)?"block":"none";break;case"hotSpotDebug":ze.style.display=J[s]?"block":"none";break;case"showControls":J[s]||(Ge.orientation.style.display="none",Ge.zoom.style.display="none",Ge.fullscreen.style.display="none");break;case"orientationOnByDefault":J[s]&&j()}e&&(i?J.title=i:delete J.title,n?J.author=n:delete J.author)}function H(){if(ae&&!ye)if(_e)t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitCancelFullScreen?t.webkitCancelFullScreen():t.msExitFullscreen&&t.msExitFullscreen();else try{i.requestFullscreen?i.requestFullscreen():i.mozRequestFullScreen?i.mozRequestFullScreen():i.msRequestFullscreen?i.msRequestFullscreen():i.webkitRequestFullScreen()}catch(e){}}function z(e){t.fullscreenElement||t.fullscreen||t.mozFullScreen||t.webkitIsFullScreen||t.msFullscreenElement?(Ge.fullscreen.classList.add("pnlm-fullscreen-toggle-button-active"),_e=!0):(Ge.fullscreen.classList.remove("pnlm-fullscreen-toggle-button-active"),_e=!1),"resize"!==e&&K("fullscreenchange",_e),Q.resize(),Y(J.hfov),L()}function G(e){var t=J.minHfov;if("multires"==J.type&&Q&&!J.multiResMinHfov&&(t=Math.min(t,Q.getCanvas().width/(J.multiRes.cubeResolution/90*.9))),t>J.maxHfov)return console.log("HFOV bounds do not make sense (minHfov > maxHfov)."),J.hfov;var a=J.hfov;a=e<t?t:e>J.maxHfov?J.maxHfov:e;return J.avoidShowingBackground&&Q&&!isNaN(J.maxPitch-J.minPitch)&&(e=Q.getCanvas(),a=Math.min(a,360*Math.atan(Math.tan((J.maxPitch-J.minPitch)/360*Math.PI)/e.height*e.width)/Math.PI)),a}function Y(e){J.hfov=G(e),K("zoomchange",J.hfov)}function q(){Te={},Ie=J.autoRotate?J.autoRotate:Ie,J.autoRotate=!1}function V(){ye&&(He.load.box.style.display="none",He.errorMsg.style.display="none",ye=!1,Fe.style.display="block",K("errorcleared")),ae=!1,c(),Ge.load.style.display="none",He.load.box.style.display="inline",o()}function X(e,i,o,r,s){var h,l,c;if(ae||(s=!0),ae=!1,Te={},J.sceneFadeDuration&&!s&&(s=Q.render(J.pitch*Math.PI/180,J.yaw*Math.PI/180,J.hfov*Math.PI/180,{returnImage:"ImageBitmap"}))!==a)return(h=s.then?t.createElement("canvas"):new Image).className="pnlm-fade-img",h.style.transition="opacity "+J.sceneFadeDuration/1e3+"s",h.style.width="100%",h.style.height="100%",s.then?s.then((function(t){h.width=t.width,h.height=t.height,h.getContext("2d").drawImage(t,0,0),X(e,i,o,r,!0)})):(h.onload=function(){X(e,i,o,r,!0)},h.src=s),Fe.appendChild(h),void(Q.fadeImg=h);s="same"===i?J.pitch:i,l="same"===o?J.yaw:"sameAzimuth"===o?J.yaw+(J.northOffset||0)-(n.scenes[e].northOffset||0):o,c="same"===r?J.hfov:r,function(){var e=J.hotSpots;if(Ce=!1,delete J.hotSpots,e)for(var t=0;t<e.length;t++){var a=e[t].div;if(a){for(;a.parentNode&&a.parentNode!=Ne;)a=a.parentNode;Ne.removeChild(a)}delete e[t].div}}(),O(e),xe.yaw=xe.pitch=xe.hfov=0,U(),s!==a&&(J.pitch=s),l!==a&&(J.yaw=l),c!==a&&(J.hfov=c),K("scenechange",e),V()}function W(){e.removeEventListener("deviceorientation",D),Ge.orientation.classList.remove("pnlm-orientation-button-active"),Me=!1}function j(){Ye&&("undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((function(t){"granted"==t&&(Me=1,e.addEventListener("deviceorientation",D),Ge.orientation.classList.add("pnlm-orientation-button-active"))})):(Me=1,e.addEventListener("deviceorientation",D),Ge.orientation.classList.add("pnlm-orientation-button-active")))}function Z(e){return n.escapeHTML?String(e).split(/&/g).join("&amp;").split('"').join("&quot;").split("'").join("&#39;").split("<").join("&lt;").split(">").join("&gt;").split("/").join("&#x2f;").split("\n").join("<br>"):String(e).split("\n").join("<br>")}function $(e,t){try{var a=decodeURIComponent(function(e){return e.replace(/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,(function(e,t){return"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""}))}(e)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return"about:blank"}return 0===a.indexOf("javascript:")||0===a.indexOf("vbscript:")?(console.log("Script URL removed."),"about:blank"):t&&0===a.indexOf("data:")?(console.log("Data URI removed from link."),"about:blank"):e}function K(e){if(e in Re)for(var t=Re[e].length;0<t;t--)Re[e][Re[e].length-t].apply(null,[].slice.call(arguments,1))}var J,Q,ee,te,ae,ie,ne,oe,re,se,he,le,ce=this,de=!1,ue=Date.now(),fe=0,me=0,pe=-1,ge=0,ve=0,we=Array(10),_e=!1,ye=!1,be=!1,xe={yaw:0,pitch:0,hfov:0},Ee=!1,Me=!1,Pe=0,Ie=0,Te={},Re={},Ae=[],Le=!1,Ce=!1,Se=!1,De={hfov:100,minHfov:50,multiResMinHfov:!1,maxHfov:120,pitch:0,minPitch:a,maxPitch:a,yaw:0,minYaw:-180,maxYaw:180,roll:0,haov:360,vaov:180,vOffset:0,autoRotate:!1,autoRotateInactivityDelay:-1,autoRotateStopDelay:a,type:"equirectangular",northOffset:0,showFullscreenCtrl:!0,dynamic:!1,dynamicUpdate:!1,doubleClickZoom:!0,keyboardZoom:!0,mouseZoom:!0,showZoomCtrl:!0,autoLoad:!1,showControls:!0,orientationOnByDefault:!1,hotSpotDebug:!1,backgroundColor:[0,0,0],avoidShowingBackground:!1,animationTimingFunction:function(e){return.5>e?2*e*e:(4-2*e)*e-1},draggable:!0,dragConfirm:!1,disableKeyboardCtrl:!1,crossOrigin:"anonymous",targetBlank:!1,touchPanSpeedCoeffFactor:1,capturedKeyNumbers:[16,17,27,37,38,39,40,61,65,68,83,87,107,109,173,187,189],friction:.15,strings:{loadButtonLabel:"Click to<br>Load<br>Panorama",loadingLabel:"Loading...",bylineLabel:"by %s",noPanoramaError:"No panorama image was specified.",fileAccessError:"The file %s could not be accessed.",malformedURLError:"There is something wrong with the panorama URL.",iOS8WebGLError:"Due to iOS 8's broken WebGL implementation, only progressive encoded JPEGs work for your device (this panorama uses standard encoding).",genericWebGLError:"Your browser does not have the necessary WebGL support to display this panorama.",textureSizeError:"This panorama is too big for your device! It's %spx wide, but your device only supports images up to %spx wide. Try another device. (If you're the author, try scaling down the image.)",unknownError:"Unknown error. Check developer console.",twoTouchActivate:"Use two fingers together to pan the panorama.",twoTouchXActivate:"Use two fingers together to pan the panorama horizontally.",twoTouchYActivate:"Use two fingers together to pan the panorama vertically.",ctrlZoomActivate:"Use %s + scroll to zoom the panorama."}};(i="string"==typeof i?t.getElementById(i):i).classList.add("pnlm-container"),i.tabIndex=0;var Ne=t.createElement("div");Ne.className="pnlm-ui",i.appendChild(Ne);var Fe=t.createElement("div");Fe.className="pnlm-render-container",i.appendChild(Fe);var ke=t.createElement("div");ke.className="pnlm-dragfix",Ne.appendChild(ke);var Be=t.createElement("span");Be.className="pnlm-about-msg";var Oe=t.createElement("a");Oe.href="https://pannellum.org/",Oe.textContent="Pannellum",Be.appendChild(Oe);var Ue=t.createElement("span");Ue.textContent=" ed132e6",Be.appendChild(Ue),Ne.appendChild(Be),ke.addEventListener("contextmenu",(function e(t){var a=d(t);Be.style.left=a.x+"px",Be.style.top=a.y+"px",clearTimeout(e.t1),clearTimeout(e.t2),Be.style.display="block",Be.style.opacity=1,e.t1=setTimeout((function(){Be.style.opacity=0}),2e3),e.t2=setTimeout((function(){Be.style.display="none"}),2500),t.preventDefault()}));var He={},ze=t.createElement("div");ze.className="pnlm-sprite pnlm-hot-spot-debug-indicator",Ne.appendChild(ze),He.container=t.createElement("div"),He.container.className="pnlm-panorama-info",He.title=t.createElement("div"),He.title.className="pnlm-title-box",He.container.appendChild(He.title),He.author=t.createElement("div"),He.author.className="pnlm-author-box",He.container.appendChild(He.author),Ne.appendChild(He.container),He.load={},He.load.box=t.createElement("div"),He.load.box.className="pnlm-load-box",He.load.boxp=t.createElement("p"),He.load.box.appendChild(He.load.boxp),He.load.lbox=t.createElement("div"),He.load.lbox.className="pnlm-lbox",He.load.lbox.innerHTML='<div class="pnlm-loading"></div>',He.load.box.appendChild(He.load.lbox),He.load.lbar=t.createElement("div"),He.load.lbar.className="pnlm-lbar",He.load.lbarFill=t.createElement("div"),He.load.lbarFill.className="pnlm-lbar-fill",He.load.lbar.appendChild(He.load.lbarFill),He.load.box.appendChild(He.load.lbar),He.load.msg=t.createElement("p"),He.load.msg.className="pnlm-lmsg",He.load.box.appendChild(He.load.msg),Ne.appendChild(He.load.box),He.errorMsg=t.createElement("div"),He.errorMsg.className="pnlm-error-msg pnlm-info-box",Ne.appendChild(He.errorMsg),He.interactionMsg=t.createElement("div"),He.interactionMsg.className="pnlm-interaction-msg pnlm-info-box",Ne.appendChild(He.interactionMsg);var Ge={};Ge.container=t.createElement("div"),Ge.container.className="pnlm-controls-container",Ne.appendChild(Ge.container),Ge.load=t.createElement("button"),Ge.load.className="pnlm-load-button",Ge.load.addEventListener("click",(function(){U(),V()})),Ne.appendChild(Ge.load),Ge.zoom=t.createElement("div"),Ge.zoom.className="pnlm-zoom-controls pnlm-controls",Ge.zoomIn=t.createElement("div"),Ge.zoomIn.className="pnlm-zoom-in pnlm-sprite pnlm-control",Ge.zoomIn.addEventListener("click",(function(){ae&&(Y(J.hfov-5),L())})),Ge.zoom.appendChild(Ge.zoomIn),Ge.zoomOut=t.createElement("div"),Ge.zoomOut.className="pnlm-zoom-out pnlm-sprite pnlm-control",Ge.zoomOut.addEventListener("click",(function(){ae&&(Y(J.hfov+5),L())})),Ge.zoom.appendChild(Ge.zoomOut),Ge.container.appendChild(Ge.zoom),Ge.fullscreen=t.createElement("div"),Ge.fullscreen.addEventListener("click",H),Ge.fullscreen.className="pnlm-fullscreen-toggle-button pnlm-sprite pnlm-fullscreen-toggle-button-inactive pnlm-controls pnlm-control",(t.fullscreenEnabled||t.mozFullScreenEnabled||t.webkitFullscreenEnabled||t.msFullscreenEnabled)&&Ge.container.appendChild(Ge.fullscreen),Ge.orientation=t.createElement("div"),Ge.orientation.addEventListener("click",(function(e){Me?W():j()})),Ge.orientation.addEventListener("mousedown",(function(e){e.stopPropagation()})),Ge.orientation.addEventListener("touchstart",(function(e){e.stopPropagation()})),Ge.orientation.addEventListener("pointerdown",(function(e){e.stopPropagation()})),Ge.orientation.className="pnlm-orientation-button pnlm-orientation-button-inactive pnlm-sprite pnlm-controls pnlm-control";var Ye=!1;e.DeviceOrientationEvent&&"https:"==location.protocol&&(0<=navigator.userAgent.toLowerCase().indexOf("mobi")||0<=navigator.userAgent.indexOf("Mac")&&navigator.maxTouchPoints&&0<navigator.maxTouchPoints)&&(Ge.container.appendChild(Ge.orientation),Ye=!0);var qe=t.createElement("div");qe.className="pnlm-compass pnlm-controls pnlm-control",Ne.appendChild(qe),n.firstScene?O(n.firstScene):n.default&&n.default.firstScene?O(n.default.firstScene):O(null),U(!0);var Ve=[],Xe=[];S.prototype.multiply=function(e){return new S(this.w*e.w-this.x*e.x-this.y*e.y-this.z*e.z,this.x*e.w+this.w*e.x+this.y*e.z-this.z*e.y,this.y*e.w+this.w*e.y+this.z*e.x-this.x*e.z,this.z*e.w+this.w*e.z+this.x*e.y-this.y*e.x)},S.prototype.toEulerAngles=function(){return[Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y)),Math.asin(2*(this.w*this.y-this.z*this.x)),Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z))]},this.isLoaded=function(){return Boolean(ae)},this.getPitch=function(){return J.pitch},this.setPitch=function(e,t,i,n){return ue=Date.now(),1e-6>=Math.abs(e-J.pitch)?("function"==typeof i&&i(n),this):((t=t==a?1e3:Number(t))?(Te.pitch={startTime:Date.now(),startPosition:J.pitch,endPosition:e,duration:t},"function"==typeof i&&setTimeout((function(){i(n)}),t)):J.pitch=e,L(),this)},this.getPitchBounds=function(){return[J.minPitch,J.maxPitch]},this.setPitchBounds=function(e){return J.minPitch=Math.max(-90,Math.min(e[0],90)),J.maxPitch=Math.max(-90,Math.min(e[1],90)),this},this.getYaw=function(){return(J.yaw+540)%360-180},this.setYaw=function(e,t,i,n){return ue=Date.now(),1e-6>=Math.abs(e-J.yaw)?("function"==typeof i&&i(n),this):(e=(e+180)%360-180,(t=t==a?1e3:Number(t))?(180<J.yaw-e?e+=360:180<e-J.yaw&&(e-=360),Te.yaw={startTime:Date.now(),startPosition:J.yaw,endPosition:e,duration:t},"function"==typeof i&&setTimeout((function(){i(n)}),t)):J.yaw=e,L(),this)},this.getYawBounds=function(){return[J.minYaw,J.maxYaw]},this.setYawBounds=function(e){return J.minYaw=Math.max(-360,Math.min(e[0],360)),J.maxYaw=Math.max(-360,Math.min(e[1],360)),this},this.getHfov=function(){return J.hfov},this.setHfov=function(e,t,i,n){return ue=Date.now(),1e-6>=Math.abs(e-J.hfov)?("function"==typeof i&&i(n),this):((t=t==a?1e3:Number(t))?(Te.hfov={startTime:Date.now(),startPosition:J.hfov,endPosition:G(e),duration:t},"function"==typeof i&&setTimeout((function(){i(n)}),t)):Y(e),L(),this)},this.getHfovBounds=function(){return[J.minHfov,J.maxHfov]},this.setHfovBounds=function(e){return J.minHfov=Math.max(0,e[0]),J.maxHfov=Math.max(0,e[1]),this},this.lookAt=function(e,t,i,n,o,r){return n=n==a?1e3:Number(n),e!==a&&1e-6<Math.abs(e-J.pitch)&&(this.setPitch(e,n,o,r),o=a),t!==a&&1e-6<Math.abs(t-J.yaw)&&(this.setYaw(t,n,o,r),o=a),i!==a&&1e-6<Math.abs(i-J.hfov)&&(this.setHfov(i,n,o,r),o=a),"function"==typeof o&&o(r),this},this.getNorthOffset=function(){return J.northOffset},this.setNorthOffset=function(e){return J.northOffset=Math.min(360,Math.max(0,e)),L(),this},this.getHorizonRoll=function(){return J.horizonRoll},this.setHorizonRoll=function(e){return J.horizonRoll=Math.min(90,Math.max(-90,e)),Q.setPose(J.horizonPitch*Math.PI/180,J.horizonRoll*Math.PI/180),L(),this},this.getHorizonPitch=function(){return J.horizonPitch},this.setHorizonPitch=function(e){return J.horizonPitch=Math.min(90,Math.max(-90,e)),Q.setPose(J.horizonPitch*Math.PI/180,J.horizonRoll*Math.PI/180),L(),this},this.startAutoRotate=function(e,t,i,n){return e=e||Ie||1,t=t===a?se:t,i=i===a?re:i,J.autoRotate=e,n!==a&&(J.autoRotateInactivityDelay=n),ce.lookAt(t,a,i,3e3),L(),this},this.stopAutoRotate=function(){return Ie=J.autoRotate?J.autoRotate:Ie,J.autoRotate=!1,J.autoRotateInactivityDelay=-1,this},this.stopMovement=function(){q(),xe={yaw:0,pitch:0,hfov:0}},this.getRenderer=function(){return Q},this.setUpdate=function(e){return Le=!0===e,Q===a?s():L(),this},this.mouseEventToCoords=function(e){return m(e)},this.loadScene=function(e,t,a,i){return!1!==ae&&X(e,t,a,i),this},this.getScene=function(){return J.scene},this.addScene=function(e,t){return n.scenes[e]=t,this},this.removeScene=function(e){return!(J.scene==e||!n.scenes.hasOwnProperty(e))&&(delete n.scenes[e],!0)},this.toggleFullscreen=function(){return H(),this},this.getConfig=function(){return J},this.getContainer=function(){return i},this.addHotSpot=function(e,t){if(t===a&&J.scene===a)J.hotSpots.push(e);else{var i=t!==a?t:J.scene;if(!n.scenes.hasOwnProperty(i))throw"Invalid scene ID!";n.scenes[i].hasOwnProperty("hotSpots")||(n.scenes[i].hotSpots=[],i==J.scene&&(J.hotSpots=n.scenes[i].hotSpots)),n.scenes[i].hotSpots.push(e)}return t!==a&&J.scene!=t||(F(e),ae&&B(e)),this},this.removeHotSpot=function(e,t){if(t===a||J.scene==t){if(!J.hotSpots)return!1;for(var i=0;i<J.hotSpots.length;i++)if(J.hotSpots[i].hasOwnProperty("id")&&J.hotSpots[i].id==e){for(var o=J.hotSpots[i].div;o.parentNode!=Ne;)o=o.parentNode;return Ne.removeChild(o),delete J.hotSpots[i].div,J.hotSpots.splice(i,1),!0}}else{if(!n.scenes.hasOwnProperty(t))return!1;if(!n.scenes[t].hasOwnProperty("hotSpots"))return!1;for(i=0;i<n.scenes[t].hotSpots.length;i++)if(n.scenes[t].hotSpots[i].hasOwnProperty("id")&&n.scenes[t].hotSpots[i].id==e)return n.scenes[t].hotSpots.splice(i,1),!0}},this.resize=function(){Q&&A()},this.isOrientationSupported=function(){return Ye||!1},this.stopOrientation=function(){W()},this.startOrientation=function(){j()},this.isOrientationActive=function(){return Boolean(Me)},this.on=function(e,t){return Re[e]=Re[e]||[],Re[e].push(t),this},this.off=function(e,t){if(!e)return Re={},this;if(t){var a=Re[e].indexOf(t);0<=a&&Re[e].splice(a,1),0==Re[e].length&&delete Re[e]}else delete Re[e];return this},this.destroy=function(){if(Se=!0,clearTimeout(oe),le&&le.abort(),Array.isArray(ie))for(var a=0;6>a;a++)ie[a].src="";Q&&Q.destroy(),be&&(t.removeEventListener("mousemove",p,!1),t.removeEventListener("mouseup",g,!1),i.removeEventListener("mozfullscreenchange",z,!1),i.removeEventListener("webkitfullscreenchange",z,!1),i.removeEventListener("msfullscreenchange",z,!1),i.removeEventListener("fullscreenchange",z,!1),he?he.disconnect():(e.removeEventListener("resize",A,!1),e.removeEventListener("orientationchange",A,!1)),i.removeEventListener("keydown",M,!1),i.removeEventListener("keyup",I,!1),i.removeEventListener("blur",P,!1),t.removeEventListener("mouseleave",g,!1)),i.innerHTML="",i.classList.remove("pnlm-container")}}return{viewer:function(e,t){return new i(e,t)}}}(window,document);const n={panoramaTarget:"trailview_panorama",mapTarget:"trailview_map",initialImageId:void 0,baseUrl:"https://trailview.cmparks.net",mapboxKey:void 0,navArrowMinAngle:-25,navArrowMaxAngle:-20,imageFetchType:"standard"};function o(e,t){return e-Math.floor(e/t)*t}class r{_options=n;_panViewer;_geo={latitude:0,longitude:0};_prevNorthOffset=0;_prevYaw=0;_currImg;_dataArr;_dataIndex=new Map;_sceneList=[];_hotSpotList=[];_prevImg;_initLat;_initLng;optimalDist=4;neighborDistCutoff=10;pruneAngle=25;_map;_mapMarker;_emitter;_sequencesData;_navArrowInfos=[];_mouseOnDot=!1;constructor(e=n){return this._emitter=new a,this._options=e,fetch(i(this._options.baseUrl,"/api/sequences"),{method:"GET"}).then((async e=>{const t=await e.json();if(!t.success)throw new Error("Failed to fetch sequence data");this._sequencesData=t.data;const a=await this._fetchData();this._dataArr=a;for(let e=0;e<this._dataArr.length;e++)this._dataIndex.set(this._dataArr[e].id,e);this._initViewer(),this._currImg&&this.goToImageID(this._currImg.id,!0)})),this}on(e,t){this._emitter.on(e,t)}_createMapLayer(e){if(void 0===this._map)throw new Error("Cannot create map layer as map is undefined");this._map.getSource("dots")&&(this._map.removeLayer("dots"),this._map.removeSource("dots"));const t={type:"FeatureCollection",features:[]};for(let a=0;a<e.length;a++){const i={type:"Feature",properties:{sequenceId:e[a].sequenceId,imageID:e[a].id,visible:e[a].visibility},geometry:{type:"Point",coordinates:[e[a].longitude,e[a].latitude]}};t.features.push(i)}const a={type:"geojson",data:{type:"FeatureCollection",features:t.features}};this._map.addSource("dots",a),this._map.addLayer({id:"dots",type:"circle",source:"dots",paint:{"circle-radius":10,"circle-color":["case",["==",["get","visible"],!0],"#00a108","#db8904"]}}),this._map.setPaintProperty("dots","circle-radius",["interpolate",["exponential",.5],["zoom"],13,3,16,5,17,7,20,8]),this._map.setPaintProperty("dots","circle-opacity",["interpolate",["exponential",.5],["zoom"],13,.05,15,.1,17,.25,20,1])}_startMap(e){this._options.mapboxKey&&this._options.mapTarget&&(t.accessToken=this._options.mapboxKey,this._map=new t.Map({container:this._options.mapTarget,style:"mapbox://styles/cleveland-metroparks/cisvvmgwe00112xlk4jnmrehn?optimize=true",center:[-81.682665,41.4097766],zoom:9.5,pitchWithRotate:!1,dragRotate:!1,touchPitch:!1,boxZoom:!1}),this._map.on("load",(()=>{this._createMapLayer(e)})),this._map.on("mouseenter","dots",(()=>{this._mouseOnDot=!0,this._map&&(this._map.getCanvas().style.cursor="pointer")})),this._map.on("mouseleave","dots",(()=>{this._mouseOnDot=!1,this._map&&(this._map.getCanvas().style.cursor="grab")})),this._map.on("mousedown",(()=>{this._map&&!this._mouseOnDot&&(this._map.getCanvas().style.cursor="grabbing")})),this._map.on("mouseup",(()=>{this._map&&this._mouseOnDot?this._map.getCanvas().style.cursor="pointer":this._map&&(this._map.getCanvas().style.cursor="grab")})),this._createMapMarker(),this._map.on("click","dots",(e=>{void 0!==e.features&&null!==e.features[0].properties?this.goToImageID(e.features[0].properties.imageID):console.warn("Features is undefiend or properties are null")})))}_createMapMarker(){if(void 0===this._map)throw new Error("Cannot create map marker as map is undefined");const e=document.createElement("div");e.classList.add("trailview-current-marker-wrapper");const a=document.createElement("div");a.classList.add("trailview-current-marker");const i=document.createElement("div");i.classList.add("trailview-marker-viewer"),e.appendChild(a),e.appendChild(i),this._mapMarker=new t.Marker(e).setLngLat([-81.682665,41.4097766]).addTo(this._map).setRotationAlignment("map"),this._updateMapMarkerRotation(),this._map.jumpTo({center:this._mapMarker.getLngLat(),zoom:16,bearing:0})}_updateMapMarkerRotation(){if(void 0!==this._panViewer&&void 0!==this._mapMarker){const e=this.getBearing();void 0!==e&&this._mapMarker.setRotation((e+225)%360)}requestAnimationFrame(this._updateMapMarkerRotation.bind(this))}_updateNavArrows(e=!1){const t=document.getElementsByClassName("trailview-nav-arrow");if(void 0!==this._panViewer){for(const e of t){const t=o(360-((a=this._panViewer.getYaw())<0&&(a=360+a),a)+e.yaw,360);e.style.transform=`scale(80%) translate(-50%, -50%) rotateZ(${t}deg) translateY(-100px)`}let e=(this._panViewer.getPitch()+90)/2.5;e>80?e=80:e<0&&(e=0),document.getElementById("trailview-nav-container").style.transform=`translate(-50%, 0) perspective(300px) rotateX(${e}deg)`}var a;e||requestAnimationFrame(this._updateNavArrows.bind(this,!1))}setData(e){this._dataArr=e;for(let e=0;e<this._dataArr.length;e++)this._dataIndex.set(this._dataArr[e].id,e);if(void 0!==this._panViewer&&void 0!==this._currImg){for(let e=0;e<this._hotSpotList.length;e++)this._panViewer.removeHotSpot(this._hotSpotList[e],this._currImg.id);for(let e=0;e<this._sceneList.length;e++)this._panViewer.removeScene(this._sceneList[e])}if(this._currImg){const e=this._dataIndex.get(this._currImg.id);void 0!==e?(this._addImageToViewer(this._dataArr[e]),this.goToImageID(this._currImg.id,!0)):console.warn("Cannt find image id in index")}}getData(){return this._dataArr}getCurrentImageID(){if(this._currImg)return this._currImg.id}getFlipped(){return this._currImg?this._currImg.flipped:void 0}getCurrentSequenceId(){return this._currImg?this._currImg.sequenceId:void 0}getPanViewer(){return this._panViewer}_createViewerConfig(e){return{default:{firstScene:e,sceneFadeDuration:1500,compass:!1,autoLoad:!0,showControls:!1,crossOrigin:"use-credentials"},scenes:{}}}_addSceneToConfig(e,t){if(!this._sequencesData)throw new Error("Cannot add scene to config as sequence data is undefined");const a=this._sequencesData.find((e=>e.id===t.sequenceId));if(!a)throw new Error(`Cannot add scene to config as sequence not found with id: ${t.sequenceId}`);return e.scenes[String(t.id)]={horizonPitch:t.pitchCorrection,hfov:120,yaw:0,northOffset:t.bearing,type:"multires",multiRes:{basePath:i(this._options.baseUrl,"/trails",`/${a.name}`,"/img",`/${t.id}`),path:"/%l/%s%y_%x",extension:"jpg",tileResolution:512,maxLevel:3,cubeResolution:1832}},e}_addImageToViewer(e,t){this._sceneList.push(e.id);let a=e.pitchCorrection,n=180;e.flipped||(a*=-1,n=0);let r=e.bearing;if(e.flipped||(r=o(r+180,360)),!this._sequencesData)return void console.warn("Cannot add scene to viewer as sequence data is undefined");const s=this._sequencesData.find((t=>t.id===e.sequenceId));if(!s)return void console.warn(`Cannot find sequence with id: ${e.sequenceId}`);const h={horizonPitch:a,hfov:120,yaw:n,northOffset:r,type:"multires",multiRes:{basePath:i(this._options.baseUrl,"/trails",`/${s.name}`,"/img",`/${e.id}`),path:"/%l/%s%y_%x",fallbackPath:"/fallback/%s",extension:"jpg",tileResolution:512,maxLevel:3,cubeResolution:1832,shtHash:t}};null!=t&&(h.multiRes.shtHash=t),void 0!==this._panViewer&&this._panViewer.addScene(e.id,h)}_createNavArrows(){const e=document.getElementById("trailview-nav-container");if(null===e)return;const t=document.getElementsByClassName("trailview-nav-arrow");for(let a=t.length-1;a>=0;--a)e.removeChild(t[a]);this._navArrowInfos.forEach((t=>{const a=document.createElement("img");a.classList.add("trailview-nav-arrow"),a.src=i(this._options.baseUrl,"/assets/img/arrow.png"),a.yaw=t.yaw,a.imageId=t.id,a.draggable=!1,a.addEventListener("click",(e=>{this.goToImageID(e.target.imageId)})),e.appendChild(a)}))}async _addNeighborsToViewer(e,t=!1){this._navArrowInfos=[];for(let a=0;a<e.length;a++){const n=await fetch(i(this._options.baseUrl,"/api/preview",`/${e[a].id}`),{method:"GET"}),r=await n.json();this._addImageToViewer(e[a],r.preview);const s=this._options.navArrowMinAngle,h=this._options.navArrowMaxAngle,l=-(h-s-e[a].distance*(h-s)/9)+h;let c=e[a].neighborBearing;t||(c=o(e[a].neighborBearing+180,360)),this._navArrowInfos.push({id:e[a].id,pitch:l,yaw:c})}this._createNavArrows()}_customMod(e,t){return e-Math.floor(e/t)*t}_getNeighbors(t){const a=new e(41,"meters"),i=[];if(void 0===this._dataArr)throw new Error("Cannot get neighbors as dataArr is undefined");for(let e=0;e<this._dataArr.length;e++){if(this._dataArr[e].id==t.id)continue;const n=a.distance([t.longitude,t.latitude],[this._dataArr[e].longitude,this._dataArr[e].latitude]);if(n<=this.neighborDistCutoff){let o=a.bearing([t.longitude,t.latitude],[this._dataArr[e].longitude,this._dataArr[e].latitude]);o<0&&(o+=360);const r=this._customMod(this._customMod(o-t.bearing,360)+180,360);let s=!1;for(let e=0;e<i.length;e++){const t=i[e];if(void 0===t)continue;const a=this._customMod(t.neighborBearing-r+180,360)-180;Math.abs(a)<this.pruneAngle&&(Math.abs(this.optimalDist-n)<Math.abs(this.optimalDist-t.distance)?i[e]=void 0:s=!0)}0==s&&i.push({sequenceId:this._dataArr[e].sequenceId,id:this._dataArr[e].id,bearing:this._dataArr[e].bearing,neighborBearing:r,flipped:this._dataArr[e].flipped,distance:n,latitude:this._dataArr[e].latitude,longitude:this._dataArr[e].longitude,shtHash:this._dataArr[e].shtHash,pitchCorrection:this._dataArr[e].pitchCorrection,visibility:this._dataArr[e].visibility})}}return i.filter((e=>void 0!==e))}_initViewer(e){if(void 0===this._dataArr)return void console.error("Cannot initialize viewer because dataArr is undefined");for(let e=0;e<this._dataArr.length;e++)this._dataIndex.set(this._dataArr[e].id,e);if(void 0===e&&(e=this._initLat&&this._initLng?this.getNearestImageId(this._initLat,this._initLng,Number.MAX_SAFE_INTEGER):this._dataArr[0].id),void 0===e)throw new Error("First image not specified");let t=this._createViewerConfig(e);const a=this._dataIndex.get(e);void 0!==a?this._currImg=this._dataArr[a]:console.warn("Cannot find image id in index"),this._currImg&&(t=this._addSceneToConfig(t,this._currImg),t=this._addSceneToConfig(t,this._currImg),this._sceneList.push(this._currImg.id)),this._panViewer=pannellum.viewer(this._options.panoramaTarget,t),this._panViewer.on("scenechange",(e=>{this._onImageChange(e)})),this._onImageChange(this._panViewer.getScene()),void 0!==this._currImg&&(this._currImg.flipped?this._panViewer.setYaw(180,!1):this._panViewer.setYaw(0,!1));const i=void 0===this._currImg?void 0:this._getNeighbors(this._currImg);if(null!==i){for(let e=0;e<this._hotSpotList.length;e++)this._panViewer.removeHotSpot(this._hotSpotList[e]);void 0!==this._currImg&&void 0!==i&&this._addNeighborsToViewer(i,this._currImg.flipped),this._startMap(this._dataArr),this._createNavContainer(),this._emitter.emit("init-done")}else console.warn("Cannot initialize as neighbors is null")}_createNavContainer(){const e=document.createElement("div");e.id="trailview-nav-container",document.getElementById(this._options.panoramaTarget)?.appendChild(e),this._updateNavArrows()}async _fetchData(){if("standard"==this._options.imageFetchType){const e=await fetch(i(this._options.baseUrl,"/api/images/standard"),{method:"GET"}),t=await e.json();return new Promise((e=>{e(t.imagesStandard)}))}{const e=await fetch(i(this._options.baseUrl,"/api/images/all"),{method:"GET"}),t=await e.json();return this._dataArr=t.imagesAll,new Promise((e=>{e(t.imagesAll)}))}}_onImageChange(e){if(void 0===e)return;if(void 0===this._panViewer)return;if(void 0===this._dataArr)return void console.error("Error on scene change, dataArr is undefined");const t=this._dataIndex.get(e);if(void 0===t)return console.error("Cannot find image in index"),console.log(e),void console.log(this._dataIndex);this._currImg=this._dataArr[t],this._prevYaw=this._panViewer.getYaw();const a=((this._prevNorthOffset-this._panViewer.getNorthOffset())%360+this._prevYaw)%360;if(this._panViewer.setYaw(a,!1),this._prevNorthOffset=this._panViewer.getNorthOffset(),this._geo.latitude=this._dataArr[t].latitude,this._geo.longitude=this._dataArr[t].longitude,void 0!==this._map&&void 0!==this._mapMarker&&(this._mapMarker.setLngLat([this._geo.longitude,this._geo.latitude]),this._map.easeTo({center:this._mapMarker.getLngLat(),duration:500})),void 0!==this._prevImg)for(let e=0;e<this._hotSpotList.length;e++)this._panViewer.removeHotSpot(this._hotSpotList[e],this._prevImg.id);this._hotSpotList=[];const i=document.getElementsByClassName("pnlm-hotspot-base");for(let e=0;e<i.length;e++)i[e].remove();const n=this._getNeighbors(this._dataArr[t]),o=[e];if(null!==n)for(let e=0;e<n.length;e++)o.push(n[e].id);for(let e=0;e<this._sceneList.length;e++)o.includes(this._sceneList[e])||this._panViewer.removeScene(this._sceneList[e]);this._sceneList=o,this._prevImg=this._currImg,null!==n&&void 0!==this._currImg&&this._addNeighborsToViewer(n,this._currImg.flipped),void 0!==this._currImg&&this._emitter.emit("image-change",this._currImg)}getNearestImageId(t,a,i=10){const n=new e(41,"meters");let o,r=Number.MAX_SAFE_INTEGER;if(void 0!==this._dataArr){for(let e=0;e<this._dataArr.length;e++){const s=n.distance([a,t],[this._dataArr[e].longitude,this._dataArr[e].latitude]);s<i&&s<r&&(o=this._dataArr[e].id,r=s)}return o}console.warn("Cannot get nearest image id as dataArr is undefined")}getImageGeo(){return this._geo}destroy(){void 0!==this._panViewer&&this._panViewer.destroy()}getBearing(){return void 0!==this._panViewer?(this._panViewer.getNorthOffset()+this._panViewer.getYaw()+180)%360:void 0}_onHotSpotClicked(e,t){"onHotSpotClickFunc"in t[0]._options&&t[0]._options.onHotSpotClickFunc(t[1])}async goToImageID(e,t=!1){if(void 0!==this._panViewer){if(t||!this._sceneList.includes(e)){if(t){for(let e=0;e<this._sceneList.length;e++)this._panViewer.removeScene(this._sceneList[e]);this._sceneList=[]}const a=await fetch(i(this._options.baseUrl,"/api/preview",`/${e}`),{method:"GET"}),n=await a.json();if(void 0!==this._dataArr){const t=this._dataIndex.get(e);void 0!==t?this._addImageToViewer(this._dataArr[t],n.preview):console.warn("Cannot find image id in index")}this._panViewer.loadScene(e,"same","same","same")}else this._panViewer.loadScene(e,"same","same","same");return this}}}export{r as TrailViewer,n as defaultOptions};
